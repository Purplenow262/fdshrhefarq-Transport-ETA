<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HK Transit</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    <link rel="icon" href="icon.jpg">
    <meta name="theme-color" content="#f2f2f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --md-sys-color-primary: #006c4c;
            --kmb-red: #e60012;
            --ctb-yellow: #f8c300; 
            --joint-grad: linear-gradient(135deg, #e60012 45%, #f8c300 55%);
        }

        body {
            font-family: 'Roboto', -apple-system, sans-serif;
            background-color: #f2f2f7; 
            margin: 0; padding: 16px;
            overscroll-behavior-y: contain; 
            padding-bottom: 90px; /* Â¢ûÂä†Â∫ïÈÉ®ÁïôÁôΩÁµ¶Â∞éËà™Âàó */
            color: #191c1a;
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 600px; margin: 0 auto; }
        
        h1 { 
            text-align: center; color: #191c1a; margin-bottom: 24px; 
            font-size: 24px; font-weight: 500; letter-spacing: 0;
        }

        /* --- View Containers --- */
        .tab-view { display: none; animation: fadeIn 0.2s; }
        .tab-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- Module A: Search & Filter --- */
        .search-container { position: relative; margin-bottom: 12px; }
        .search-box {
            width: 100%; padding: 16px 20px; font-size: 16px; border: none;
            border-radius: 28px; background: #eef2f5; box-shadow: none; 
            box-sizing: border-box; transition: all 0.2s;
        }
        .search-box:focus { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); outline: 2px solid #555; }

        .filter-row {
            display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px;
        }
        .filter-btn {
            flex: 1; padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd;
            background: #fff; font-size: 14px; font-weight: 700; color: #747775;
            cursor: pointer; text-align: center; transition: all 0.2s; white-space: nowrap;
        }
        .filter-btn.active {
            border-color: transparent; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .filter-btn[data-co="KMB"].active { background: var(--kmb-red); }
        .filter-btn[data-co="CTB"].active { background: var(--ctb-yellow); color: #000; }
        .filter-btn[data-co="MTR"].active { background: #00498C; }

        /* --- Module B: Dashboard --- */
        .group-card {
            background: #fff; border-radius: 16px; padding: 16px; margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .group-header {
            font-size: 18px; font-weight: 700; color: #006c4c; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .refresh-btn {
            background: none; border: none; font-size: 20px; color: #006c4c; cursor: pointer;
        }
        .saved-stop-item {
            display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;
        }
        .saved-stop-item:last-child { border-bottom: none; }
        .saved-route-no {
            font-size: 18px; font-weight: 900; width: 60px; color: #191c1a; flex-shrink: 0;
        }
        .saved-info { flex-grow: 1; font-size: 14px; color: #444; line-height: 1.3; }
        .saved-dest { font-weight: 500; color: #000; }
        .saved-stop-name { font-size: 12px; color: #747775; }
        .saved-eta { font-weight: 700; color: var(--kmb-red); font-family: monospace; font-size: 16px; text-align: right; min-width: 60px; }
        
        .delete-btn {
            margin-left: 8px; color: #999; font-size: 12px; border: 1px solid #eee; 
            border-radius: 4px; padding: 2px 6px; background: none;
        }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 64px;
            background: #fff; display: flex; border-top: 1px solid #e0e2e0;
            z-index: 900; box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #747775; font-size: 12px; font-weight: 500; cursor: pointer;
            transition: color 0.2s;
        }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .nav-item.active { color: #006c4c; }
        .nav-item:active { background: #f5f5f5; }

        /* Route List Item */
        .route-card {
            background: white; border-radius: 12px; padding: 16px;
            margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.1s; border-left: 5px solid transparent;
        }
        .route-card:active { background: #f0f0f0; }
        .op-avatar {
            width: 40px; height: 40px; border-radius: 50%; display: flex; 
            justify-content: center; align-items: center; font-size: 10px; font-weight: 900; 
            color: white; margin-right: 16px; flex-shrink: 0; text-transform: uppercase;
        }
        .bg-kmb { background: var(--kmb-red); }
        .bg-ctb { background: var(--ctb-yellow); color: black; }
        .bg-joint { background: var(--joint-grad); }
        .route-info { flex-grow: 1; }
        .route-number { font-size: 20px; font-weight: 700; color: #191c1a; }
        .route-dest { font-size: 14px; color: #444746; margin-top: 2px; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.4);
            justify-content: center; align-items: flex-end; z-index: 1000;
        }
        .modal-content {
            background: #fff; border-radius: 28px 28px 0 0; width: 100%; max-width: 600px; 
            height: 92vh; display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.25s cubic-bezier(0.2, 0, 0, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header { padding: 16px 24px; border-bottom: 1px solid #e0e2e0; position: relative; flex-shrink: 0; }
        .modal-title { font-size: 24px; font-weight: 500; color: #191c1a; margin: 0; }
        .modal-subtitle { color: #444746; font-size: 14px; margin-top: 4px; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 0; -webkit-overflow-scrolling: touch;}
        .close-btn {
            position: absolute; top: 16px; right: 24px;
            background: #f0f0f0; border: none; width: 32px; height: 32px;
            border-radius: 50%; font-size: 18px; cursor: pointer; color: #444;
        }

        /* Stops & ETA */
        .stop-item { 
            padding: 16px 24px; border-bottom: 1px solid #f1f1f1; 
            cursor: pointer; display: flex; flex-direction: column;
            user-select: none; transition: background 0.2s;
        }
        .stop-item:active { background: #f5f5f5; }
        .stop-item.holding { background: #e8f0fe; } 
        
        .stop-row { display: flex; align-items: center; }
        .stop-timeline { width: 24px; display: flex; flex-direction: column; align-items: center; margin-right: 16px; }
        .stop-dot { width: 12px; height: 12px; border: 2px solid #747775; border-radius: 50%; background: #fff; box-sizing: border-box; }
        .stop-name { font-size: 16px; color: #191c1a; font-weight: 500; line-height: 1.4; }

        .eta-container { margin-top: 8px; padding-left: 40px; display: none; }
        .eta-badge { display: flex; align-items: center; padding: 4px 0; font-family: 'Roboto', monospace; }
        .co-pill { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-right: 8px; width: 30px; text-align: center; }
        .pill-kmb { background: #ffe0e0; color: #b30000; }
        .pill-ctb { background: #fff5cc; color: #806000; }
        .eta-main { font-size: 16px; font-weight: 700; color: #191c1a; }
        .eta-abs { font-size: 14px; color: #747775; font-weight: 400; margin-left: 6px; }
        
        .loading { text-align: center; color: #747775; margin-top: 40px; font-size: 14px;}
        
        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 2px; padding: 16px; position: fixed;
            z-index: 2000; left: 50%; bottom: 80px; transform: translateX(-50%);
            font-size: 14px; border-radius: 24px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 50px; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 50px; opacity: 0;} }
    </style>
</head>
<body>

<div class="container">
    <h1>HK Transit</h1>
    
    <div id="view-dashboard" class="tab-view active">
        <div id="dashboard-container"></div>
    </div>

    <div id="view-search" class="tab-view">
        <div class="search-container">
            <input type="text" id="search-input" class="search-box" placeholder="üîç ÊêúÂ∞ã (e.g. 101, TKL)...">
        </div>

        <div class="filter-row">
            <div class="filter-btn active" data-co="KMB" onclick="setFilter('KMB')">KMB</div>
            <div class="filter-btn" data-co="CTB" onclick="setFilter('CTB')">CTB</div>
            <div class="filter-btn" data-co="MTR" onclick="setFilter('MTR')">MTR</div>
        </div>

        <div id="route-list">
            <div class="loading">Ë´ãËº∏ÂÖ•Ë∑ØÁ∑öËôüÁ¢ºÊàñ MTR ‰ª£Ëôü</div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('dashboard')">
        <div class="nav-icon">üè†</div>
        <div>ÊàëÁöÑÊî∂Ëóè</div>
    </div>
    <div class="nav-item" onclick="switchTab('search')">
        <div class="nav-icon">üîç</div>
        <div>ÊêúÂ∞ãË∑ØÁ∑ö</div>
    </div>
</div>

<div id="route-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div id="modal-title" class="modal-title"></div>
            <div id="modal-subtitle" class="modal-subtitle"></div>
            <button class="close-btn" onclick="closeModal()">‚úï</button>
        </div>
        <div id="modal-body" class="modal-body"></div>
    </div>
</div>

<div id="toast"></div>

<script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    const API_KMB = 'https://data.etabus.gov.hk/v1/transport/kmb';
    const API_CTB = 'https://rt.data.gov.hk/v2/transport/citybus';
    const API_MTR = 'https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php';
    
    // --- Data Store ---
    let allRoutes = []; 
    let currentFilter = 'KMB';
    
    // --- Navigation Logic ---
    function switchTab(tabName) {
        // Hide all views
        document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active'));
        // Deactivate nav items
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        // Show selected
        if(tabName === 'dashboard') {
            document.getElementById('view-dashboard').classList.add('active');
            document.querySelectorAll('.nav-item')[0].classList.add('active');
            renderDashboard(); // Refresh Dashboard when entered
        } else {
            document.getElementById('view-search').classList.add('active');
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            // Auto focus search if empty
            if(document.getElementById('search-input').value === '') {
               document.getElementById('search-input').focus();
            }
        }
    }

    // --- Module B: Dashboard & Storage Logic ---
    let userGroups = JSON.parse(localStorage.getItem('hkTransitGroups')) || [
        { id: 'g1', name: 'üíº ‰∏äÁè≠ (Morning)', stops: [] },
        { id: 'g2', name: 'üè† ÂõûÂÆ∂ (Evening)', stops: [] }
    ];

    function saveGroups() {
        localStorage.setItem('hkTransitGroups', JSON.stringify(userGroups));
        renderDashboard();
    }

    function showToast(msg) {
        const x = document.getElementById("toast");
        x.innerText = msg;
        x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }

    // --- MTR Static Data (Shortened) ---
    const MTR_LINES = {
        'AEL': { name: 'Ê©üÂ†¥Âø´Á∂´', color: '#1C7670', stops: ['HOK','KOW','TSY','AIR','AWE'] },
        'TCL': { name: 'Êù±Ê∂åÁ∂´', color: '#fe7f1d', stops: ['HOK','KOW','OLY','NAC','LAK','TSY','SUN','TUC'] },
        'TML': { name: 'Â±ØÈ¶¨Á∂´', color: '#9a3b26', stops: ['WKS','MOS','HEO','TSH','SHM','CIO','STW','CKT','TAW','HIK','DIH','KAT','SUW','TKW','HOM','HUH','ETS','AUS','NAC','MEF','TWW','KSR','YUL','LOP','TIS','SIH','TUM'] },
        'TKL': { name: 'Â∞áËªçÊæ≥Á∂´', color: '#6b208b', stops: ['NOP','QUB','YAT','TIK','TKO','LHP','HAH','POA'] },
        'EAL': { name: 'Êù±ÈêµÁ∂´', color: '#53b7e8', stops: ['ADM','EXC','HUH','MKK','KOT','TAW','SHT','FOT','RAC','UNI','TAP','TWO','FAN','SHS','LOW','LMC'] },
        'SIL': { name: 'ÂçóÊ∏ØÂ≥∂Á∂´', color: '#b5bd00', stops: ['ADM','OCP','WCH','LET','SOH'] },
        'TWL': { name: 'ËçÉÁÅ£Á∂´', color: '#ff0000', stops: ['CEN','ADM','TST','JOR','YMT','MOK','PRE','SSP','CSW','LCK','MEF','LAK','KWF','KWH','TWH','TSW'] },
        'ISL': { name: 'Ê∏ØÂ≥∂Á∂´', color: '#0860a8', stops: ['KET','HKU','SYP','SHW','CEN','ADM','WAC','CAB','TIH','FOH','NOP','QUB','TAK','SWH','SKW','HFC','CHW'] },
        'KTL': { name: 'ËßÄÂ°òÁ∂´', color: '#1a9431', stops: ['WHA','HOM','YMT','MOK','PRE','SKM','KOT','LOF','WTP','DIH','CHH','KOB','NTK','KWT','LAT','YAT','TIK'] },
        'DRL': { name: 'Ëø™Â£´Â∞ºÁ∂´', color: '#f550a6', stops: ['SUN','DIS'] }
    };
    const MTR_STATION_NAMES = {
        'KET': 'Â†ÖÂ∞ºÂú∞Âüé', 'HKU': 'È¶ôÊ∏ØÂ§ßÂ≠∏', 'SYP': 'Ë•øÁáüÁõ§', 'SHW': '‰∏äÁí∞', 'CEN': '‰∏≠Áí∞', 'ADM': 'ÈáëÈêò', 'WAC': 'ÁÅ£‰ªî', 'CAB': 'ÈäÖÈëºÁÅ£', 'TIH': 'Â§©Âêé', 'FOH': 'ÁÇÆÂè∞Â±±', 'NOP': 'ÂåóËßí', 'QUB': 'È∞ÇÈ≠öÊ∂å', 'TAK': 'Â§™Âè§', 'SWH': 'Ë•øÁÅ£Ê≤≥', 'SKW': 'Á≠≤ÁÆïÁÅ£', 'HFC': 'ÊùèËä±ÈÇ®', 'CHW': 'Êü¥ÁÅ£',
        'TST': 'Â∞ñÊ≤ôÂíÄ', 'JOR': '‰ΩêÊï¶', 'YMT': 'Ê≤πÈ∫ªÂú∞', 'MOK': 'Êó∫Ëßí', 'PRE': 'Â§™Â≠ê', 'SSP': 'Ê∑±Ê∞¥Âüó', 'CSW': 'Èï∑Ê≤ôÁÅ£', 'LCK': 'ËçîÊûùËßí', 'MEF': 'ÁæéÂ≠ö', 'LAK': 'ËçîÊôØ', 'KWF': 'ËëµËä≥','KWH': 'ËëµËàà', 'TWH': 'Â§ßÁ™©Âè£', 'TSW': 'ËçÉÁÅ£',
        'WHA': 'ÈªÉÂüî', 'HOM': '‰ΩïÊñáÁî∞', 'SKM': 'Áü≥Á°§Â∞æ', 'KOT': '‰πùÈæçÂ°ò', 'LOF': 'Ê®ÇÂØå', 'WTP': 'ÈªÉÂ§ß‰ªô', 'DIH': 'ÈëΩÁü≥Â±±', 'CHH': 'ÂΩ©Ëôπ', 'KOB': '‰πùÈæçÁÅ£', 'NTK': 'ÁâõÈ†≠Ëßí', 'KWT': 'ËßÄÂ°ò', 'LAT': 'ËóçÁî∞', 'YAT': 'Ê≤πÂ°ò', 'TIK': 'Ë™øÊôØÂ∂∫', 'TKO': 'Â∞áËªçÊæ≥', 'LHP': 'Â∫∑Âüé', 'HAH': 'ÂùëÂè£', 'POA': 'ÂØ∂Áê≥',
        'HOK': 'È¶ôÊ∏Ø', 'KOW': '‰πùÈæç', 'OLY': 'Â•ßÈÅã', 'NAC': 'ÂçóÊòå', 'TSY': 'ÈùíË°£', 'SUN': 'Ê¨£Êæ≥', 'TUC': 'Êù±Ê∂å', 'AIR': 'Ê©üÂ†¥', 'AWE': 'ÂçöË¶ΩÈ§®',
        'EXC': 'ÊúÉÂ±ï', 'HUH': 'Á¥ÖÁ£°', 'MKK': 'Êó∫ËßíÊù±', 'TAW': 'Â§ßÂúç', 'SHT': 'Ê≤ôÁî∞', 'FOT': 'ÁÅ´ÁÇ≠', 'RAC': 'È¶¨Â†¥', 'UNI': 'Â§ßÂ≠∏', 'TAP': 'Â§ßÂüîÂ¢ü', 'TWO': 'Â§™Âíå', 'FAN': 'Á≤âÂ∂∫', 'SHS': '‰∏äÊ∞¥', 'LOW': 'ÁæÖÊπñ', 'LMC': 'ËêΩÈ¶¨Ê¥≤',
        'WKS': 'ÁÉèÊ∫™Ê≤ô', 'MOS': 'È¶¨ÈûçÂ±±', 'HEO': 'ÊÅÜÂÆâ', 'TSH': 'Â§ßÊ∞¥Âùë', 'SHM': 'Áü≥ÈñÄ', 'CIO': 'Á¨¨‰∏ÄÂüé', 'STW': 'Ê≤ôÁî∞Âúç', 'CKT': 'ËªäÂÖ¨Âªü', 'HIK': 'È°ØÂæë', 'KAT': 'ÂïüÂæ∑', 'SUW': 'ÂÆãÁöáËá∫', 'TKW': 'ÂúüÁìúÁÅ£', 'ETS': 'Â∞ñÊù±', 'AUS': 'ÊüØÂ£´Áî∏', 'TWW': 'ËçÉÁÅ£Ë•ø', 'KSR': 'Èå¶‰∏äË∑Ø', 'YUL': 'ÂÖÉÊúó', 'LOP': 'ÊúóÂ±è', 'TIS': 'Â§©Ê∞¥Âúç', 'SIH': 'ÂÖÜÂ∫∑', 'TUM': 'Â±ØÈñÄ',
        'OCP': 'Êµ∑Ê¥ãÂÖ¨Âúí', 'WCH': 'ÈªÉÁ´πÂùë', 'LET': 'Âà©Êù±', 'SOH': 'Êµ∑ÊÄ°ÂçäÂ≥∂', 'DIS': 'Ëø™Â£´Â∞º'
    };

    // --- Init ---
    Promise.all([
        fetch(`${API_KMB}/route/`).then(r => r.json()),
        fetch(`${API_CTB}/route/CTB`).then(r => r.json())
    ]).then(([kmbData, ctbData]) => {
        let routeMap = new Map();
        // KMB
        kmbData.data.forEach(r => {
            if(r.service_type === '1') {
                const key = `${r.route}_${r.bound === 'O' ? 'out' : 'in'}`;
                routeMap.set(key, { type: 'bus', route: r.route, co: 'KMB', dest: r.dest_tc, orig: r.orig_tc, boundKey: r.bound === 'O' ? 'outbound' : 'inbound', id: key, isJoint: false });
            }
        });
        // CTB & Merge
        ctbData.data.forEach(r => {
            const isXHT = /^(1|3|6|9)\d{2}/.test(r.route) && r.route !== 'R8' && r.route !== 'S1';
            const outKey = `${r.route}_out`;
            if (isXHT && routeMap.has(outKey)) { routeMap.get(outKey).co = 'JOINT'; routeMap.get(outKey).isJoint = true; }
            else if (!routeMap.has(outKey)) { routeMap.set(outKey, { type: 'bus', route: r.route, co: 'CTB', dest: r.dest_tc, orig: r.orig_tc, boundKey: 'outbound', id: outKey, isJoint: false }); }

            const inKey = `${r.route}_in`;
            if (isXHT && routeMap.has(inKey)) { routeMap.get(inKey).co = 'JOINT'; routeMap.get(inKey).isJoint = true; }
            else if (!routeMap.has(inKey)) { routeMap.set(inKey, { type: 'bus', route: r.route, co: 'CTB', dest: r.orig_tc, orig: r.dest_tc, boundKey: 'inbound', id: inKey, isJoint: false }); }
        });

        const mtrRoutes = Object.keys(MTR_LINES).map(code => ({ type: 'mtr', route: MTR_LINES[code].name, code: code, color: MTR_LINES[code].color, dest: 'Êü•ÁúãËªäÁ´ô', co: 'MTR' }));
        allRoutes = [...mtrRoutes, ...Array.from(routeMap.values()).sort((a,b) => a.route.localeCompare(b.route, undefined, {numeric: true}))];
        
        renderDashboard(); // Init Dashboard
    });

    // --- UI Logic ---
    function setFilter(co) {
        if (currentFilter === co) return;
        currentFilter = co;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            if(btn.dataset.co === co) btn.classList.add('active');
            else btn.classList.remove('active');
        });
        handleSearch();
    }

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', handleSearch);

    function handleSearch() {
        const val = searchInput.value.trim().toUpperCase();
        filterAndRender(val);
    }

    function filterAndRender(searchTerm) {
        const list = document.getElementById('route-list');
        
        if (searchTerm === '') {
            list.innerHTML = '<div class="loading">Ë´ãËº∏ÂÖ•Ë∑ØÁ∑öËôüÁ¢ºÊàñ MTR ‰ª£Ëôü</div>';
            return;
        }
        
        list.innerHTML = '';
        
        const filtered = allRoutes.filter(r => {
            const matchesSearch = r.route.includes(searchTerm);
            if (!matchesSearch) return false;
            if (currentFilter === 'MTR') return r.type === 'mtr';
            if (r.type !== 'bus') return false;
            if (currentFilter === 'KMB') return r.co === 'KMB' || r.co === 'JOINT';
            if (currentFilter === 'CTB') return r.co === 'CTB' || r.co === 'JOINT';
            return false;
        });

        if(filtered.length === 0) { list.innerHTML = '<div class="loading">Êâæ‰∏çÂà∞Ë∑ØÁ∑ö</div>'; return; }
        
        filtered.slice(0, 50).forEach(r => {
            const d = document.createElement('div');
            d.className = 'route-card';
            d.onclick = () => r.type === 'mtr' ? openMtrModal(r) : openBusModal(r);
            
            let avatarHtml = r.type === 'mtr' 
                ? `<div class="op-avatar" style="background:${r.color}">MTR</div>`
                : `<div class="op-avatar ${r.co==='CTB'?'bg-ctb':r.co==='JOINT'?'bg-joint':'bg-kmb'}">${r.co==='JOINT'?'JNT':r.co}</div>`;

            d.innerHTML = `
                ${avatarHtml}
                <div class="route-info">
                    <div class="route-number">${r.route}</div>
                    <div class="route-dest">${r.type === 'bus' ? '<span style="font-size:12px;color:#888">ÂæÄ</span> ' : ''}${r.dest}</div>
                </div>`;
            list.appendChild(d);
        });
    }

    // --- Module B: Dashboard Render & Logic ---
    function renderDashboard() {
        const container = document.getElementById('dashboard-container');
        container.innerHTML = '';
        
        userGroups.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group-card';
            groupDiv.innerHTML = `
                <div class="group-header">
                    ${group.name} 
                    <button class="refresh-btn" onclick="refreshGroup('${group.id}')">‚Üª</button>
                </div>
                <div class="group-stops" id="group-stops-${group.id}"></div>
            `;
            
            const stopsDiv = groupDiv.querySelector('.group-stops');
            if(group.stops.length === 0) {
                stopsDiv.innerHTML = '<div style="color:#999;font-size:13px;padding:8px;">Âú®„ÄåÊêúÂ∞ã„ÄçÈ†ÅÈù¢Èï∑ÊåâÁ´ôÈªûÂç≥ÂèØÂä†ÂÖ•</div>';
            } else {
                group.stops.forEach((stop, idx) => {
                    const stopRow = document.createElement('div');
                    stopRow.className = 'saved-stop-item';
                    stopRow.innerHTML = `
                        <div class="saved-route-no">${stop.route}</div>
                        <div class="saved-info">
                            <div class="saved-dest">ÂæÄ ${stop.dest}</div>
                            <div class="saved-stop-name">${stop.stopName}</div>
                        </div>
                        <div class="saved-eta" id="dash-eta-${group.id}-${idx}">...</div>
                        <button class="delete-btn" onclick="removeStop('${group.id}', ${idx})">‚úï</button>
                    `;
                    stopsDiv.appendChild(stopRow);
                    fetchDashboardEta(stop, `dash-eta-${group.id}-${idx}`);
                });
            }
            container.appendChild(groupDiv);
        });
    }

    function removeStop(groupId, idx) {
        const group = userGroups.find(g => g.id === groupId);
        if(group) {
            group.stops.splice(idx, 1);
            saveGroups();
        }
    }

    function refreshGroup(groupId) {
        const group = userGroups.find(g => g.id === groupId);
        if(!group) return;
        group.stops.forEach((stop, idx) => {
            document.getElementById(`dash-eta-${group.id}-${idx}`).innerText = '...';
            fetchDashboardEta(stop, `dash-eta-${group.id}-${idx}`);
        });
    }

    async function fetchDashboardEta(stop, elemId) {
        const el = document.getElementById(elemId);
        if(!el) return;
        
        try {
            if(stop.type === 'mtr') {
                const res = await fetch(`${API_MTR}?line=${stop.line}&sta=${stop.stopId}`);
                const json = await res.json();
                const key = `${stop.line}-${stop.stopId}`;
                if(json.status === 0 || !json.data[key]) { el.innerText = '-'; return; }
                
                const trains = [...(json.data[key].UP || []), ...(json.data[key].DOWN || [])];
                const relevant = trains.filter(t => t.dest === stop.destCode); 
                if(relevant.length > 0) {
                     const min = Math.max(0, Math.floor((new Date(relevant[0].time.replace(/-/g, "/")) - new Date())/60000));
                     el.innerText = min + 'min';
                } else { el.innerText = '-'; }

            } else {
                const targetDir = stop.dir === 'outbound' ? 'O' : 'I';
                let promises = [];
                if(stop.kmbId && stop.kmbId !== 'null') promises.push(fetch(`${API_KMB}/eta/${stop.kmbId}/${stop.route}/1`).then(r=>r.json()).then(d=>d.data.map(e=>({...e, co:'KMB'}))));
                if(stop.ctbId && stop.ctbId !== 'null') promises.push(fetch(`${API_CTB}/eta/CTB/${stop.ctbId}/${stop.route}`).then(r=>r.json()).then(d=>d.data.map(e=>({...e, co:'CTB'}))));
                
                const results = await Promise.all(promises);
                const allEtas = results.flat().filter(e => e.dir === targetDir && e.eta).sort((a,b)=>new Date(a.eta)-new Date(b.eta));
                
                if(allEtas.length > 0) {
                    const min = Math.max(0, Math.floor((new Date(allEtas[0].eta) - new Date())/60000));
                    el.innerText = min === 0 ? 'Âç≥ÈÅî' : min + 'min';
                    el.style.color = allEtas[0].co === 'KMB' ? 'var(--kmb-red)' : '#d6a600';
                } else { el.innerText = '-'; }
            }
        } catch(e) { el.innerText = 'Err'; }
    }

    // --- Modal & Stop Logic (with Long Press) ---
    async function openBusModal(route) {
        setupModal(route.route, route.dest);
        const listDiv = document.getElementById('modal-body');
        listDiv.innerHTML = '<div class="loading">ËºâÂÖ•‰∏≠...</div>';

        try {
            let finalStops = [];
            const dirCode = route.boundKey; 

            if (route.isJoint) {
                const [kmbRes, ctbRes] = await Promise.all([
                    fetch(`${API_KMB}/route-stop/${route.route}/${dirCode}/1`).then(r=>r.json()),
                    fetch(`${API_CTB}/route-stop/CTB/${route.route}/${dirCode}`).then(r=>r.json())
                ]);
                const kmbStops = await Promise.all(kmbRes.data.map(s => fetch(`${API_KMB}/stop/${s.stop}`).then(r=>r.json()).then(d=>({seq:s.seq, id:s.stop, name:d.data.name_tc}))));
                finalStops = kmbStops.map(k => {
                    const c = ctbRes.data ? ctbRes.data.find(x => parseInt(x.seq)===parseInt(k.seq)) : null;
                    return { name: k.name, kmbId: k.id, ctbId: c?c.stop:null, route: route.route, dir: route.boundKey, dest: route.dest, type: 'bus', co: route.co };
                });
            } else if (route.co === 'KMB') {
                const res = await fetch(`${API_KMB}/route-stop/${route.route}/${dirCode}/1`).then(r=>r.json());
                finalStops = await Promise.all(res.data.map(s => fetch(`${API_KMB}/stop/${s.stop}`).then(r=>r.json()).then(d=>({name:d.data.name_tc, kmbId:s.stop, ctbId:null, route:route.route, dir:route.boundKey, dest:route.dest, type:'bus', co:'KMB'}))));
            } else {
                const res = await fetch(`${API_CTB}/route-stop/CTB/${route.route}/${dirCode}`).then(r=>r.json());
                if(res.data) finalStops = await Promise.all(res.data.map(s => fetch(`${API_CTB}/stop/${s.stop}`).then(r=>r.json()).then(d=>({name:d.data.name_tc, kmbId:null, ctbId:s.stop, route:route.route, dir:route.boundKey, dest:route.dest, type:'bus', co:'CTB'}))));
            }
            renderStops(finalStops, 'bus');
        } catch(e) { listDiv.innerHTML = '<div class="loading">ËºâÂÖ•Â§±Êïó</div>'; }
    }

    async function openMtrModal(route) {
        setupModal(route.route, 'ÈõôÂêëÁè≠Ê¨°');
        const lineData = MTR_LINES[route.code];
        const stops = lineData.stops.map(s => ({
            name: MTR_STATION_NAMES[s] || s,
            stopId: s,
            line: route.code,
            route: route.route,
            color: route.color,
            type: 'mtr'
        }));
        renderStops(stops, 'mtr');
    }

    function renderStops(stops, type) {
        const listDiv = document.getElementById('modal-body');
        let html = '';
        stops.forEach((s, i) => {
            const dataStr = encodeURIComponent(JSON.stringify(s));
            const dotStyle = type==='mtr' ? `style="border-color:${s.color}"` : '';
            html += `
                <div class="stop-item" 
                    onmousedown="handlePressStart(this, '${dataStr}')" 
                    ontouchstart="handlePressStart(this, '${dataStr}')" 
                    onmouseup="handlePressEnd(this, '${dataStr}')" 
                    ontouchend="handlePressEnd(this, '${dataStr}')"
                    onmouseleave="cancelPress(this)"
                >
                    <div class="stop-row">
                        <div class="stop-timeline"><div class="stop-dot" ${dotStyle}></div></div>
                        <div class="stop-name">${s.name}</div>
                    </div>
                    <div class="eta-container"></div>
                </div>`;
        });
        listDiv.innerHTML = html;
    }

    // --- Long Press & ETA ---
    let pressTimer;
    let isLongPress = false;

    function handlePressStart(elem, dataStr) {
        isLongPress = false;
        elem.classList.add('holding');
        pressTimer = setTimeout(() => {
            isLongPress = true;
            elem.classList.remove('holding');
            promptAddToGroup(JSON.parse(decodeURIComponent(dataStr)));
        }, 600); 
    }

    function handlePressEnd(elem, dataStr) {
        clearTimeout(pressTimer);
        elem.classList.remove('holding');
        if (!isLongPress) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            if(data.type === 'mtr') toggleMtrEta(data.line, data.stopId, elem);
            else toggleBusEta(data.kmbId, data.ctbId, data.route, data.dir, elem);
        }
    }

    function cancelPress(elem) {
        clearTimeout(pressTimer);
        elem.classList.remove('holding');
    }

    function promptAddToGroup(stopData) {
        const choice = confirm(`Â∞á„Äå${stopData.name}„ÄçÂä†ÂÖ•„Äå‰∏äÁè≠„ÄçÁæ§ÁµÑÂóéÔºü\n(ÊåâÂèñÊ∂àÂâáÂä†ÂÖ•„ÄåÂõûÂÆ∂„Äç)`);
        const targetGroupId = choice ? 'g1' : 'g2';
        const targetGroup = userGroups.find(g => g.id === targetGroupId);
        
        const exists = targetGroup.stops.some(s => s.route === stopData.route && s.stopName === stopData.name);
        if(exists) { showToast('Ë©≤Á´ôÈªûÂ∑≤Âú®Áæ§ÁµÑ‰∏≠'); return; }

        if (stopData.type === 'mtr') {
            const dest = prompt("Ë´ãËº∏ÂÖ•MTRÊñπÂêë‰ª£Ëôü (‰æãÂ¶ÇÂæÄ‰∏≠Áí∞Ëº∏ÂÖ• CEN, ÂæÄÊü¥ÁÅ£Ëº∏ÂÖ• CHW):", "CEN");
            if(!dest) return;
            stopData.destCode = dest.toUpperCase();
            stopData.dest = MTR_STATION_NAMES[stopData.destCode] || stopData.destCode;
        }

        targetGroup.stops.push(stopData);
        saveGroups();
        showToast(`Â∑≤Âä†ÂÖ• ${targetGroup.name}`);
        
        // Optional: Switch to dashboard to show result
        // switchTab('dashboard'); 
    }

    async function toggleBusEta(kmbId, ctbId, routeNo, boundKey, elem) {
        const container = elem.querySelector('.eta-container');
        if (container.style.display === 'block') { container.style.display = 'none'; return; }
        
        container.style.display = 'block';
        container.innerHTML = '<span style="color:#999;font-size:13px;">ËºâÂÖ•‰∏≠...</span>';
        const targetDir = boundKey === 'outbound' ? 'O' : 'I';

        try {
            let promises = [];
            if (kmbId && kmbId !== 'null') promises.push(fetch(`${API_KMB}/eta/${kmbId}/${routeNo}/1`).then(r => r.json()).then(d => d.data.map(e => ({...e, co: 'KMB'}))));
            if (ctbId && ctbId !== 'null') promises.push(fetch(`${API_CTB}/eta/CTB/${ctbId}/${routeNo}`).then(r => r.json()).then(d => d.data.map(e => ({...e, co: 'CTB'}))));

            const results = await Promise.all(promises);
            let allEtas = results.flat().filter(e => e.dir === targetDir && e.eta).sort((a, b) => new Date(a.eta) - new Date(b.eta));

            if (allEtas.length === 0) { container.innerHTML = '<span style="color:#999;font-size:13px;">Êö´ÁÑ°Áè≠Ê¨°</span>'; return; }

            let etaHtml = '';
            allEtas.slice(0, 3).forEach(e => {
                const min = Math.max(0, Math.floor((new Date(e.eta) - new Date()) / 60000));
                etaHtml += `<div class="eta-badge"><span class="co-pill ${e.co==='KMB'?'pill-kmb':'pill-ctb'}">${e.co}</span><span class="eta-main">${min}min</span><span class="eta-abs">(${new Date(e.eta).toLocaleTimeString('en-GB',{hour12:false})})</span></div>`;
            });
            container.innerHTML = etaHtml;
        } catch (err) { container.innerHTML = 'ÈÄ£Á∑öÈåØË™§'; }
    }

    async function toggleMtrEta(line, station, elem) {
        const container = elem.querySelector('.eta-container');
        if (container.style.display === 'block') { container.style.display = 'none'; return; }
        container.style.display = 'block'; container.innerHTML = '...';

        const res = await fetch(`${API_MTR}?line=${line}&sta=${station}`);
        const json = await res.json();
        const key = `${line}-${station}`;
        if(!json.data[key]) { container.innerHTML = 'Êö´ÁÑ°Êï∏Êìö'; return; }
        
        const trains = [...(json.data[key].UP||[]), ...(json.data[key].DOWN||[])];
        const groups = {};
        trains.forEach(t => { if(!groups[t.dest]) groups[t.dest]=[]; groups[t.dest].push(t); });
        
        let html = '';
        Object.keys(groups).forEach(d => {
            html += `<div style="margin-top:8px;font-weight:700;color:#00498C">ÂæÄ ${MTR_STATION_NAMES[d]||d}</div>`;
            groups[d].slice(0,2).forEach(t => {
                const min = Math.max(0, Math.floor((new Date(t.time.replace(/-/g,"/")) - new Date())/60000));
                html += `<div style="padding-left:12px">${min}min <small>(${t.time.split(' ')[1].substr(0,5)})</small></div>`;
            });
        });
        container.innerHTML = html || 'Êö´ÁÑ°Áè≠Ê¨°';
    }

    function setupModal(title, sub) {
        const m = document.getElementById('route-modal');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-subtitle').innerText = sub;
        m.style.display = 'flex';
    }
    function closeModal() { document.getElementById('route-modal').style.display = 'none'; }
</script>

</body>
</html>