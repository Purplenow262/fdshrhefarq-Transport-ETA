<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HK Transit</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.jpg">
    <meta name="theme-color" content="#f2f2f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --md-sys-color-primary: #006c4c;
            --kmb-red: #e60012;
            --ctb-yellow: #f8c300; 
            --joint-grad: linear-gradient(135deg, #e60012 45%, #f8c300 55%);
            --lwb-orange: #ff6600;
            --joint-lwb-grad: linear-gradient(135deg, #ff6600 45%, #f8c300 55%);
        }

        body {
            font-family: 'Roboto', -apple-system, sans-serif;
            background-color: #f2f2f7; 
            margin: 0; padding: 16px;
            overscroll-behavior-y: contain; 
            padding-bottom: 90px; /* Â¢ûÂä†Â∫ïÈÉ®ÁïôÁôΩÁµ¶Â∞éËà™Âàó */
            color: #191c1a;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ensure full-height pages on mobile so scrolling works as expected */
        html, body { height: 100%; }

        .container { max-width: 600px; margin: 0 auto; }
        
        h1 { 
            text-align: center; color: #191c1a; margin-bottom: 24px; 
            font-size: 24px; font-weight: 500; letter-spacing: 0;
        }

        /* --- View Containers --- */
        .tab-view { display: none; animation: fadeIn 0.2s; }
        .tab-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- Module A: Search & Filter --- */
        .search-container { position: relative; margin-bottom: 12px; }
        .search-box {
            width: 100%; padding: 16px 20px; font-size: 16px; border: none;
            border-radius: 28px; background: #eef2f5; box-shadow: none; 
            box-sizing: border-box; transition: all 0.2s;
        }
        .search-box:focus { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); outline: 2px solid #555; }

        .filter-row {
            display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px;
        }
        .filter-btn {
            flex: 1; padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd;
            background: #fff; font-size: 14px; font-weight: 700; color: #747775;
            cursor: pointer; text-align: center; transition: all 0.2s; white-space: nowrap;
        }
        .filter-btn.active {
            border-color: transparent; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .filter-btn[data-co="KMB"].active { background: var(--kmb-red); }
        .filter-btn[data-co="CTB"].active { background: var(--ctb-yellow); color: #000; }
        .filter-btn[data-co="MTR"].active { background: #ac2e44; }

        /* --- Module B: Dashboard --- */
        .group-card {
            background: #fff; border-radius: 16px; padding: 16px; margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .group-header {
            font-size: 18px; font-weight: 700; color: #006c4c; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .group-selected-summary { font-size: 12px; color: #666; margin-bottom: 8px; }
        .refresh-btn {
            background: none; border: none; font-size: 20px; color: #006c4c; cursor: pointer;
        }
        .saved-stop-item {
            display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;
        }
        .saved-stop-item:last-child { border-bottom: none; }
        .saved-route-no {
            font-size: 18px; font-weight: 900; width:72px; color: #191c1a; flex-shrink: 0; text-align: center;
        }
        .saved-info { flex-grow: 1; font-size: 14px; color: #444; line-height: 1.3; }
        .saved-dest { font-weight: 500; color: #000; }
        .saved-stop-name { font-size: 12px; color: #747775; }
        .saved-stop-selected { font-size: 12px; color: #888; margin-top:4px; }
        .saved-eta { display: flex; flex-direction: column; gap: 6px; text-align: right; min-width: 90px; }
        .saved-eta-item { font-weight: 700; font-size: 14px; display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
        .saved-eta-co { font-size: 10px; font-weight: 700; padding: 2px 4px; border-radius: 3px; text-transform: uppercase; }
        .saved-eta-co.kmb { background: #ffe0e0; color: #b30000; }
        .saved-eta-co.ctb { background: #fff5cc; color: #806000; }
        .saved-eta-co.lwb { background: #ffebd6; color: #cc5200; }
        .saved-eta-time { font-family: monospace; color: #191c1a; }
        .saved-eta-abs { font-size: 12px; color: #747775; font-weight: 400; }
        
        .delete-btn {
            margin-left: 8px; color: #999; font-size: 12px; border: 1px solid #eee; 
            border-radius: 4px; padding: 2px 6px; background: none;
        }

        /* --- Pull to Refresh --- */
        #ptr-indicator {
            position: absolute;
            top: -50px;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #555;
        }
        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 64px;
            background: #fff; display: flex; border-top: 1px solid #e0e2e0;
            z-index: 900; box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #747775; font-size: 12px; font-weight: 500; cursor: pointer;
            transition: color 0.2s;
        }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .nav-item.active { color: #006c4c; }
        .nav-item:active { background: #f5f5f5; }

        /* Route List Item */
        .route-card {
            background: white; border-radius: 12px; padding: 16px;
            margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.1s; border-left: 5px solid transparent;
        }
        .route-card:active { background: #f0f0f0; }
        .op-avatar {
            width: 40px; height: 40px; border-radius: 50%; display: flex; 
            justify-content: center; align-items: center; font-size: 10px; font-weight: 900; 
            color: white; margin-right: 16px; flex-shrink: 0; text-transform: uppercase;
        }
        .bg-kmb { background: var(--kmb-red); }
        .bg-ctb { background: var(--ctb-yellow); color: black; }
        .bg-joint { background: var(--joint-grad); }
        .bg-lwb { background: var(--lwb-orange); }
        .bg-joint-lwb { background: var(--joint-lwb-grad); }
          /* Route list: make route number a fixed-width column (96px) and place destination on the same line */
          .route-info { flex-grow: 1; display: flex; align-items: center; gap: 12px; }
          .route-number { font-size: 20px; font-weight: 700; color: #191c1a; flex: 0 0 96px; text-align: left; }
          .route-dest { font-size: 14px; color: #444746; margin-top: 0; flex: 1; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.4);
            justify-content: center; align-items: flex-end; z-index: 1000;
        }
        .modal-content {
            background: #fff; border-radius: 28px 28px 0 0; width: 100%; max-width: 600px; 
            height: 92vh; display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.25s cubic-bezier(0.2, 0, 0, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header { padding: 16px 24px; border-bottom: 1px solid #e0e2e0; position: relative; flex-shrink: 0; }
        .modal-title { font-size: 24px; font-weight: 500; color: #191c1a; margin: 0; }
        .modal-subtitle { color: #444746; font-size: 14px; margin-top: 4px; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 0; -webkit-overflow-scrolling: touch;}
        .close-btn {
            position: absolute; top: 16px; right: 24px;
            background: #f0f0f0; border: none; width: 32px; height: 32px;
            border-radius: 50%; font-size: 18px; cursor: pointer; color: #444;
        }

        /* Stops & ETA */
        .stop-item { 
            padding: 16px 24px; border-bottom: 1px solid #f1f1f1; 
            cursor: pointer; display: flex; flex-direction: column;
            user-select: none; transition: background 0.2s;
        }
        .stop-item:active { background: #f5f5f5; }
        .stop-item.holding { background: #e8f0fe; } 
        
        .stop-row { display: flex; align-items: center; }
        .stop-timeline { width: 24px; display: flex; flex-direction: column; align-items: center; margin-right: 16px; }
        .stop-dot { width: 12px; height: 12px; border: 2px solid #747775; border-radius: 50%; background: #fff; box-sizing: border-box; }
        .stop-name { font-size: 16px; color: #191c1a; font-weight: 500; line-height: 1.4; }

        .eta-container { margin-top: 8px; padding-left: 40px; display: none; }
        .eta-badge { display: flex; align-items: center; padding: 4px 0; font-family: 'Roboto', monospace; }
        .eta-badge { display: flex; align-items: center; padding: 4px 0; font-family: 'Roboto', monospace; justify-content: space-between; touch-action: manipulation; }
        .eta-left { display:flex; align-items:center; gap:8px; }
        .eta-dest { font-size:13px; color:#444; margin-left:12px; white-space:nowrap; }
        .eta-add-btn { background:#006c4c; color:white; border:none; border-radius:8px; padding:6px 8px; font-weight:700; cursor:pointer; margin-left:8px; }
        .add-stop-btn { background:#006c4c; color:white; border:none; border-radius:8px; padding:6px 8px; font-weight:700; cursor:pointer; margin-left:12px; }
        .co-pill { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-right: 8px; width: 30px; text-align: center; }
        .pill-kmb { background: #ffe0e0; color: #b30000; }
        .pill-ctb { background: #fff5cc; color: #806000; }
        .pill-lwb { background: #ffebd6; color: #cc5200; }
        .eta-main { font-size: 16px; font-weight: 700; color: #191c1a; }
        .eta-abs { font-size: 14px; color: #747775; font-weight: 400; margin-left: 6px; }
        
        .loading { text-align: center; color: #747775; margin-top: 40px; font-size: 14px;}
        
        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 2px; padding: 16px; position: fixed;
            z-index: 2000; left: 50%; bottom: 80px; transform: translateX(-50%);
            font-size: 14px; border-radius: 24px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 50px; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 50px; opacity: 0;} }

        .group-select-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1100; }
        .group-select-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 16px; max-width: 90%; width: 320px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .group-select-header { padding: 20px; border-bottom: 1px solid #e0e0e0; font-size: 18px; font-weight: 500; }
        .group-select-body { flex-grow: 1; overflow-y: auto; padding: 0; }
        .group-option { padding: 16px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .group-option:last-child { border-bottom: none; }
        .group-option:active { background: #f5f5f5; }
        .group-select-footer { padding: 12px 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 8px; }
        .group-select-footer button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; }
        .group-btn-cancel { background: #f0f0f0; color: #333; }
        .group-btn-add { background: #006c4c; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>HK Transit</h1>
    
    <div id="view-dashboard" class="tab-view active">
        <div id="dashboard-container"></div>
    </div>

    <div id="view-search" class="tab-view">
        <div class="search-container">
            <input type="text" id="search-input" class="search-box" placeholder="üîç ÊêúÂ∞ã (e.g. 101, TKL)...">
        </div>

        <div class="filter-row">
            <div class="filter-btn active" data-co="KMB" onclick="setFilter('KMB')">KMB</div>
            <div class="filter-btn" data-co="CTB" onclick="setFilter('CTB')">CTB</div>
            <div class="filter-btn" data-co="MTR" onclick="setFilter('MTR')">MTR</div>
        </div>

        <div id="route-list">
            <div class="loading">Ë´ãËº∏ÂÖ•Ë∑ØÁ∑öËôüÁ¢º</div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('dashboard')">
        <div class="nav-icon">üè†</div>
        <div>ÊàëÁöÑÊî∂Ëóè</div>
    </div>
    <div class="nav-item" onclick="switchTab('search')">
        <div class="nav-icon">üîç</div>
        <div>ÊêúÂ∞ãË∑ØÁ∑ö</div>
    </div>
</div>

<div id="route-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div id="modal-title" class="modal-title"></div>
            <div id="modal-subtitle" class="modal-subtitle"></div>
            <button class="close-btn" onclick="closeModal()">‚úï</button>
        </div>
        <div id="modal-body" class="modal-body"></div>
    </div>
</div>

<div id="group-select-modal" class="group-select-modal" onclick="if(event.target.id==='group-select-modal')this.style.display='none'">
    <div class="group-select-content">
        <div class="group-select-header">ÈÅ∏ÊìáË¶ÅÂä†ÂÖ•ÁöÑÁæ§ÁµÑ</div>
        <div class="group-select-body"></div>
        <div class="group-select-footer">
            <button class="group-btn-cancel" onclick="document.getElementById('group-select-modal').style.display='none'">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<div id="rename-group-modal" class="group-select-modal" onclick="if(event.target.id==='rename-group-modal')this.style.display='none'">
    <div class="group-select-content">
        <div class="group-select-header">Á∑®ËºØÁæ§ÁµÑÂêçÁ®±</div>
        <div class="group-select-body" style="padding: 20px;">
            <input type="text" id="rename-group-input" class="search-box" style="width: 100%; margin-bottom: 0;">
        </div>
        <div class="group-select-footer">
            <button class="group-btn-cancel" onclick="document.getElementById('rename-group-modal').style.display='none'">ÂèñÊ∂à</button>
            <button id="rename-group-save-btn" class="group-btn-add" onclick="saveGroupName()">ÂÑ≤Â≠ò</button>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    const API_KMB = 'https://data.etabus.gov.hk/v1/transport/kmb';
    const API_CTB = 'https://rt.data.gov.hk/v2/transport/citybus';
    const API_MTR = 'https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php';
    
    // --- Data Store ---
    let allRoutes = []; 
    let currentFilter = 'KMB';
    
    // --- Navigation Logic ---
    function switchTab(tabName) {
        // Hide all views
        document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active'));
        // Deactivate nav items
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        // Show selected
        if(tabName === 'dashboard') {
            document.getElementById('view-dashboard').classList.add('active');
            document.querySelectorAll('.nav-item')[0].classList.add('active');
            renderDashboard(); // Refresh Dashboard when entered
        } else {
            document.getElementById('view-search').classList.add('active');
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            // Auto focus search if empty
            if(document.getElementById('search-input').value === '') {
               document.getElementById('search-input').focus();
            }
        }
    }

    // --- Module B: Dashboard & Storage Logic ---
    let userGroups = JSON.parse(localStorage.getItem('hkTransitGroups')) || [
        { id: 'g1', name: 'üíº ‰∏äÁè≠ (Morning)', stops: [], sortAsc: true },
        { id: 'g2', name: 'üè† ÂõûÂÆ∂ (Evening)', stops: [], sortAsc: true }
    ];
    // Ensure older saved groups have sortAsc flag
    userGroups.forEach(g => { if (typeof g.sortAsc === 'undefined') g.sortAsc = true; });

    async function saveGroups() {
        localStorage.setItem('hkTransitGroups', JSON.stringify(userGroups));
        await renderDashboard();
    }

    // Toggle sort order for a specific group and re-render
    async function toggleGroupSort(groupId) {
        const g = userGroups.find(x => x.id === groupId);
        if (!g) return;
        g.sortAsc = !g.sortAsc;
        await saveGroups();
    }

    async function moveGroup(groupId, direction) {
        const index = userGroups.findIndex(g => g.id === groupId);
        if (index === -1) return;

        if (direction === 'up' && index > 0) {
            [userGroups[index - 1], userGroups[index]] = [userGroups[index], userGroups[index - 1]];
        } else if (direction === 'down' && index < userGroups.length - 1) {
            [userGroups[index], userGroups[index + 1]] = [userGroups[index + 1], userGroups[index]];
        }
        await saveGroups();
    }

    function showToast(msg) {
        const x = document.getElementById("toast");
        x.innerText = msg;
        x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }

    // --- MTR Static Data (Shortened) ---
    const MTR_LINES = {
        'AEL': { name: 'Ê©üÂ†¥Âø´Á∂´', color: '#1C7670', stops: ['HOK','KOW','TSY','AIR','AWE'] },
        'TCL': { name: 'Êù±Ê∂åÁ∂´', color: '#fe7f1d', stops: ['HOK','KOW','OLY','NAC','LAK','TSY','SUN','TUC'] },
        'TML': { name: 'Â±ØÈ¶¨Á∂´', color: '#9a3b26', stops: ['WKS','MOS','HEO','TSH','SHM','CIO','STW','CKT','TAW','HIK','DIH','KAT','SUW','TKW','HOM','HUH','ETS','AUS','NAC','MEF','TWW','KSR','YUL','LOP','TIS','SIH','TUM'] },
        'TKL': { name: 'Â∞áËªçÊæ≥Á∂´', color: '#6b208b', stops: ['NOP','QUB','YAT','TIK','TKO','LHP','HAH','POA'] },
        'EAL': { name: 'Êù±ÈêµÁ∂´', color: '#53b7e8', stops: ['ADM','EXC','HUH','MKK','KOT','TAW','SHT','FOT','RAC','UNI','TAP','TWO','FAN','SHS','LOW','LMC'] },
        'SIL': { name: 'ÂçóÊ∏ØÂ≥∂Á∂´', color: '#b5bd00', stops: ['ADM','OCP','WCH','LET','SOH'] },
        'TWL': { name: 'ËçÉÁÅ£Á∂´', color: '#ff0000', stops: ['CEN','ADM','TST','JOR','YMT','MOK','PRE','SSP','CSW','LCK','MEF','LAK','KWF','KWH','TWH','TSW'] },
        'ISL': { name: 'Ê∏ØÂ≥∂Á∂´', color: '#0860a8', stops: ['KET','HKU','SYP','SHW','CEN','ADM','WAC','CAB','TIH','FOH','NOP','QUB','TAK','SWH','SKW','HFC','CHW'] },
        'KTL': { name: 'ËßÄÂ°òÁ∂´', color: '#1a9431', stops: ['WHA','HOM','YMT','MOK','PRE','SKM','KOT','LOF','WTP','DIH','CHH','KOB','NTK','KWT','LAT','YAT','TIK'] },
        'DRL': { name: 'Ëø™Â£´Â∞ºÁ∂´', color: '#f550a6', stops: ['SUN','DIS'] }
    };
    const MTR_STATION_NAMES = {
        'KET': 'Â†ÖÂ∞ºÂú∞Âüé', 'HKU': 'È¶ôÊ∏ØÂ§ßÂ≠∏', 'SYP': 'Ë•øÁáüÁõ§', 'SHW': '‰∏äÁí∞', 'CEN': '‰∏≠Áí∞', 'ADM': 'ÈáëÈêò', 'WAC': 'ÁÅ£‰ªî', 'CAB': 'ÈäÖÈëºÁÅ£', 'TIH': 'Â§©Âêé', 'FOH': 'ÁÇÆÂè∞Â±±', 'NOP': 'ÂåóËßí', 'QUB': 'È∞ÇÈ≠öÊ∂å', 'TAK': 'Â§™Âè§', 'SWH': 'Ë•øÁÅ£Ê≤≥', 'SKW': 'Á≠≤ÁÆïÁÅ£', 'HFC': 'ÊùèËä±ÈÇ®', 'CHW': 'Êü¥ÁÅ£',
        'TST': 'Â∞ñÊ≤ôÂíÄ', 'JOR': '‰ΩêÊï¶', 'YMT': 'Ê≤πÈ∫ªÂú∞', 'MOK': 'Êó∫Ëßí', 'PRE': 'Â§™Â≠ê', 'SSP': 'Ê∑±Ê∞¥Âüó', 'CSW': 'Èï∑Ê≤ôÁÅ£', 'LCK': 'ËçîÊûùËßí', 'MEF': 'ÁæéÂ≠ö', 'LAK': 'ËçîÊôØ', 'KWF': 'ËëµËä≥','KWH': 'ËëµËàà', 'TWH': 'Â§ßÁ™©Âè£', 'TSW': 'ËçÉÁÅ£',
        'WHA': 'ÈªÉÂüî', 'HOM': '‰ΩïÊñáÁî∞', 'SKM': 'Áü≥Á°§Â∞æ', 'KOT': '‰πùÈæçÂ°ò', 'LOF': 'Ê®ÇÂØå', 'WTP': 'ÈªÉÂ§ß‰ªô', 'DIH': 'ÈëΩÁü≥Â±±', 'CHH': 'ÂΩ©Ëôπ', 'KOB': '‰πùÈæçÁÅ£', 'NTK': 'ÁâõÈ†≠Ëßí', 'KWT': 'ËßÄÂ°ò', 'LAT': 'ËóçÁî∞', 'YAT': 'Ê≤πÂ°ò', 'TIK': 'Ë™øÊôØÂ∂∫', 'TKO': 'Â∞áËªçÊæ≥', 'LHP': 'Â∫∑Âüé', 'HAH': 'ÂùëÂè£', 'POA': 'ÂØ∂Áê≥',
        'HOK': 'È¶ôÊ∏Ø', 'KOW': '‰πùÈæç', 'OLY': 'Â•ßÈÅã', 'NAC': 'ÂçóÊòå', 'TSY': 'ÈùíË°£', 'SUN': 'Ê¨£Êæ≥', 'TUC': 'Êù±Ê∂å', 'AIR': 'Ê©üÂ†¥', 'AWE': 'ÂçöË¶ΩÈ§®',
        'EXC': 'ÊúÉÂ±ï', 'HUH': 'Á¥ÖÁ£°', 'MKK': 'Êó∫ËßíÊù±', 'TAW': 'Â§ßÂúç', 'SHT': 'Ê≤ôÁî∞', 'FOT': 'ÁÅ´ÁÇ≠', 'RAC': 'È¶¨Â†¥', 'UNI': 'Â§ßÂ≠∏', 'TAP': 'Â§ßÂüîÂ¢ü', 'TWO': 'Â§™Âíå', 'FAN': 'Á≤âÂ∂∫', 'SHS': '‰∏äÊ∞¥', 'LOW': 'ÁæÖÊπñ', 'LMC': 'ËêΩÈ¶¨Ê¥≤',
        'WKS': 'ÁÉèÊ∫™Ê≤ô', 'MOS': 'È¶¨ÈûçÂ±±', 'HEO': 'ÊÅÜÂÆâ', 'TSH': 'Â§ßÊ∞¥Âùë', 'SHM': 'Áü≥ÈñÄ', 'CIO': 'Á¨¨‰∏ÄÂüé', 'STW': 'Ê≤ôÁî∞Âúç', 'CKT': 'ËªäÂÖ¨Âªü', 'HIK': 'È°ØÂæë', 'KAT': 'ÂïüÂæ∑', 'SUW': 'ÂÆãÁöáËá∫', 'TKW': 'ÂúüÁìúÁÅ£', 'ETS': 'Â∞ñÊù±', 'AUS': 'ÊüØÂ£´Áî∏', 'TWW': 'ËçÉÁÅ£Ë•ø', 'KSR': 'Èå¶‰∏äË∑Ø', 'YUL': 'ÂÖÉÊúó', 'LOP': 'ÊúóÂ±è', 'TIS': 'Â§©Ê∞¥Âúç', 'SIH': 'ÂÖÜÂ∫∑', 'TUM': 'Â±ØÈñÄ',
        'OCP': 'Êµ∑Ê¥ãÂÖ¨Âúí', 'WCH': 'ÈªÉÁ´πÂùë', 'LET': 'Âà©Êù±', 'SOH': 'Êµ∑ÊÄ°ÂçäÂ≥∂', 'DIS': 'Ëø™Â£´Â∞º'
    };

    // --- Init ---
    Promise.all([
        fetch(`${API_KMB}/route/`).then(r => r.json()),
        fetch(`${API_CTB}/route/CTB`).then(r => r.json())
    ]).then(([kmbData, ctbData]) => {
        let routeMap = new Map();
        // KMB
        kmbData.data.forEach(r => {
            if(r.service_type === '1') {
                const key = `${r.route}_${r.bound === 'O' ? 'out' : 'in'}`;
                routeMap.set(key, { type: 'bus', route: r.route, co: 'KMB', dest: r.dest_tc, orig: r.orig_tc, boundKey: r.bound === 'O' ? 'outbound' : 'inbound', id: key, isJoint: false });
            }
        });
        // CTB & Merge
        ctbData.data.forEach(r => {
            const isJointCandidate = /^N?(1|3|6|9)\d{2}/.test(r.route) || ['R8', 'S1'].includes(r.route);
            const outKey = `${r.route}_out`;
            if (isJointCandidate && routeMap.has(outKey)) { routeMap.get(outKey).co = 'JOINT'; routeMap.get(outKey).isJoint = true; }
            else if (!routeMap.has(outKey)) { routeMap.set(outKey, { type: 'bus', route: r.route, co: 'CTB', dest: r.dest_tc, orig: r.orig_tc, boundKey: 'outbound', id: outKey, isJoint: false }); }

            const inKey = `${r.route}_in`;
            if (isJointCandidate && routeMap.has(inKey)) { routeMap.get(inKey).co = 'JOINT'; routeMap.get(inKey).isJoint = true; }
            else if (!routeMap.has(inKey)) { routeMap.set(inKey, { type: 'bus', route: r.route, co: 'CTB', dest: r.orig_tc, orig: r.dest_tc, boundKey: 'inbound', id: inKey, isJoint: false }); }
        });

        const mtrRoutes = Object.keys(MTR_LINES).map(code => ({ type: 'mtr', route: MTR_LINES[code].name, code: code, color: MTR_LINES[code].color, dest: 'Êü•ÁúãËªäÁ´ô', co: 'MTR' }));
        allRoutes = [...mtrRoutes, ...Array.from(routeMap.values()).sort((a,b) => a.route.localeCompare(b.route, undefined, {numeric: true}))];
        
        renderDashboard(); // Init Dashboard
    });

    // --- UI Logic ---
    function setFilter(co) {
        if (currentFilter === co) return;
        currentFilter = co;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            if(btn.dataset.co === co) btn.classList.add('active');
            else btn.classList.remove('active');
        });
        // Disable search input when MTR is selected
        searchInput.disabled = (co === 'MTR');
        // Clear search input when switching filters
        searchInput.value = '';
        handleSearch();
    }

    // Helper: resolve bus destination from stored stop data or the allRoutes cache
    function resolveBusDestination(stopOrRoute) {
        if (!stopOrRoute) return null;
        // If passed a stop object with dest, use it
        if (stopOrRoute.dest) return stopOrRoute.dest;
        // If passed a route-like object {route, co}
        const routeNo = stopOrRoute.route || stopOrRoute.routeNo || null;
        const co = stopOrRoute.co || null;
        if (!routeNo || !allRoutes) return null;
        const match = allRoutes.find(r => r.type === 'bus' && r.route === routeNo && (!co || r.co === co || r.co === 'JOINT'));
        return match ? match.dest : null;
    }

    // Helper: check if an ETA entry matches a given route number
    function routeMatches(entry, routeNo) {
        if (!routeNo) return true;
        const er = (entry.route || entry.routeno || entry.Route || entry.RouteNo || entry.route_no || '').toString().trim();
        return er === routeNo.toString().trim();
    }

    function getStopFromElem(elem) {
        try {
            if (!elem || !elem.dataset || !elem.dataset.stop) return null;
            return JSON.parse(decodeURIComponent(elem.dataset.stop));
        } catch (e) { return null; }
    }

    // ETA long-press handlers (separate from stop-item press)
    function etaPressStart(elem) {
        if (!elem) return;
        elem._etaLongPress = false;
        elem.classList.add('holding');
        elem._etaPressTimer = setTimeout(() => {
            elem._etaLongPress = true;
            elem.classList.remove('holding');
            try { const stop = JSON.parse(decodeURIComponent(elem.dataset.stop)); promptAddToGroup(stop); } catch (e) {}
        }, 600);
    }
    function etaPressEnd(elem) {
        if (!elem) return;
        clearTimeout(elem._etaPressTimer);
        elem._etaPressTimer = null;
        elem.classList.remove('holding');
    }
    function etaCancel(elem) { if (!elem) return; clearTimeout(elem._etaPressTimer); elem._etaPressTimer = null; elem.classList.remove('holding'); }

    // Mouse/Touch wrappers to prevent duplicate triggers
    function handleTouchPressStart(elem, dataStr, ev) {
        window.__lastTouchTime = Date.now();
        return handlePressStart(elem, dataStr);
    }
    function handleTouchPressEnd(elem, dataStr, ev) {
        return handlePressEnd(elem, dataStr);
    }
    function handleMousePressStart(elem, dataStr) {
        if (window.__lastTouchTime && Date.now() - window.__lastTouchTime < 700) return; 
        return handlePressStart(elem, dataStr);
    }
    function handleMousePressEnd(elem, dataStr) {
        if (window.__lastTouchTime && Date.now() - window.__lastTouchTime < 700) return; 
        return handlePressEnd(elem, dataStr);
    }

    function etaTouchStart(elem, ev) {
        window.__lastTouchTime = Date.now();
        return etaPressStart(elem);
    }
    function etaTouchEnd(elem, ev) {
        return etaPressEnd(elem);
    }
    function etaMouseStart(elem) {
        if (window.__lastTouchTime && Date.now() - window.__lastTouchTime < 700) return;
        return etaPressStart(elem);
    }
    function etaMouseEnd(elem) {
        if (window.__lastTouchTime && Date.now() - window.__lastTouchTime < 700) return;
        return etaPressEnd(elem);
    }

    // Touch double-tap helper: call promptAddToGroup on double-tap
    function etaTouchTap(elem, ev) {
        try {
            const now = Date.now();
            const last = elem._lastEtaTap || 0;
            elem._lastEtaTap = now;
            if (now - last < 350) {
                const stop = JSON.parse(decodeURIComponent(elem.dataset.stop));
                promptAddToGroup(stop);
            }
        } catch (e) { /* ignore */ }
    }

    // Stop double-tap helper for stop-item
    function stopTouchTap(elem, ev) {
        try {
            const now = Date.now();
            const last = elem._lastStopTap || 0;
            elem._lastStopTap = now;
            if (now - last < 350) {
                const stop = JSON.parse(decodeURIComponent(elem.dataset.stop));
                promptAddToGroup(stop);
            }
        } catch (e) { /* ignore */ }
    }

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', handleSearch);

    function handleSearch() {
        const val = searchInput.value.trim().toUpperCase();
        filterAndRender(val);
    }

    function isLWB(route) {
        if (['N30', 'N31', 'N42', 'N42A', 'N64'].includes(route)) return true;
        if (/^(A|NA|E|S|R)/.test(route)) return true;
        return false;
    }
    function isLwbCtbJoint(route) {
        return ['R8', 'S1'].includes(route);
    }

    function filterAndRender(searchTerm) {
        const list = document.getElementById('route-list');
        list.innerHTML = '';
        
        const filtered = allRoutes.filter(r => {
            // If search term is empty, show all that match current filter (top 10)
            if (searchTerm === '') {
                if (currentFilter === 'MTR') return r.type === 'mtr';
                if (r.type !== 'bus') return false;
                if (currentFilter === 'KMB') return r.co === 'KMB' || r.co === 'JOINT';
                if (currentFilter === 'CTB') return r.co === 'CTB' || r.co === 'JOINT';
                return false;
            }
            
            // If search term exists, filter by search
            const matchesSearch = r.route.includes(searchTerm);
            if (!matchesSearch) return false;
            if (currentFilter === 'MTR') return r.type === 'mtr';
            if (r.type !== 'bus') return false;
            if (currentFilter === 'KMB') return r.co === 'KMB' || r.co === 'JOINT';
            if (currentFilter === 'CTB') return r.co === 'CTB' || r.co === 'JOINT';
            return false;
        });

        if(filtered.length === 0) { list.innerHTML = '<div class="loading">Êâæ‰∏çÂà∞Ë∑ØÁ∑ö</div>'; return; }
        
        filtered.forEach(r => {
            const d = document.createElement('div');
            d.className = 'route-card';
            d.onclick = () => r.type === 'mtr' ? openMtrModal(r) : openBusModal(r);
            
            let avatarHtml, routeNumHtml;
            if (r.type === 'mtr') {
                avatarHtml = `<div class="op-avatar" style="background:${r.color}; width:auto; border-radius:10px; padding:0 12px; font-size:14px; font-weight:500;">${r.route}</div>`;
                routeNumHtml = '';
            } else {
                let coClass = 'bg-kmb', coText = r.co;
                if (r.co === 'CTB') { coClass = 'bg-ctb'; }
                else if (r.co === 'JOINT') {
                    coClass = isLwbCtbJoint(r.route) ? 'bg-joint-lwb' : 'bg-joint';
                    coText = 'JNT';
                } else {
                    if (isLWB(r.route)) { coClass = 'bg-lwb'; coText = 'LWB'; }
                }
                avatarHtml = `<div class="op-avatar ${coClass}">${coText}</div>`;
                routeNumHtml = `<div class="route-number">${r.route}</div>`;
            }

            const routeDest = r.type === 'bus' ? (r.dest || resolveBusDestination(r) || '') : r.dest;
            d.innerHTML = `
                ${avatarHtml}
                <div class="route-info">
                    ${routeNumHtml}
                    <div class="route-dest">${r.type === 'bus' ? '<span style="font-size:12px;color:#888"></span> ' : ''}${routeDest}</div>
                </div>`;
            list.appendChild(d);
        });
    }

    // --- Module B: Dashboard Render & Logic ---
    async function renderDashboard() {
        const container = document.getElementById('dashboard-container');
        container.innerHTML = '';
        const allNormalModePromises = [];

        for (const [index, group] of userGroups.entries()) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group-card';
            const sortIcon = group.sortAsc ? '‚Üë' : '‚Üì';
            const isFirst = index === 0;
            const isLast = index === userGroups.length - 1;
            const upArrow = isFirst ? '' : `<button class="refresh-btn" onclick="moveGroup('${group.id}', 'up')" style="font-size:16px;">‚ñ≤</button>`;
            const downArrow = isLast ? '' : `<button class="refresh-btn" onclick="moveGroup('${group.id}', 'down')" style="font-size:16px;">‚ñº</button>`;

            groupDiv.innerHTML = `
                <div class="group-header">
                    <span style="cursor:pointer;" onclick="editGroupName('${group.id}')">${group.name}</span>
                    <div style="display:flex;gap:8px;align-items:center;">
                        ${upArrow}${downArrow}
                        <button class="refresh-btn" onclick="refreshGroup('${group.id}')">‚Üª</button>
                        <button class="refresh-btn" onclick="toggleGroupSort('${group.id}')">${sortIcon}</button>
                        <button class="refresh-btn" onclick="deleteGroup('${group.id}')" style="font-size:16px;">üóë</button>
                    </div>
                </div>
                <div class="group-stops" id="group-stops-${group.id}"></div>
            `;

            const stopsDiv = groupDiv.querySelector('.group-stops');
            if (group.stops.length === 0) {
                stopsDiv.innerHTML = '<div style="color:#999;font-size:13px;padding:8px;">Âú®„ÄåÊêúÂ∞ã„ÄçÈ†ÅÈù¢Èï∑ÊåâÁ´ôÈªûÂç≥ÂèØÂä†ÂÖ•</div>';
            } else {
                if (group.sortAsc) {
                    // Ascending mode: flatten all departures from all stops, each departure is one row
                    const perStopDeps = await Promise.all(group.stops.map((stop, origIdx) => fetchDeparturesForStop(stop).then(list => ({ stop, origIdx, list }))));
                    let depResults = [];
                    perStopDeps.forEach(p => {
                        const { stop, origIdx, list } = p;
                        if (!list || list.length === 0) return;
                        // If joint route (both operators), take up to 3 per operator
                        const isJoint = stop.co === 'JOINT' || (stop.kmbId && stop.ctbId);
                        if (isJoint) {
                            const byKMB = list.filter(x => x.co === 'KMB').slice(0,3).map(x => ({...x, stop, origIdx}));
                            const byCTB = list.filter(x => x.co === 'CTB').slice(0,3).map(x => ({...x, stop, origIdx}));
                            depResults = depResults.concat(byKMB, byCTB);
                        } else {
                            // non-joint: include up to 3 upcoming, or 4 for MTR
                            const sliceNum = stop.type === 'mtr' ? 4 : 3;
                            depResults = depResults.concat(list.slice(0, sliceNum).map(x => ({...x, stop, origIdx})));
                        }
                    });
                    // sort combined results by time and limit to 30 rows
                    depResults.sort((a,b) => a.time.getTime() - b.time.getTime());
                    depResults.slice(0, 30).forEach((d, i) => {
                        const row = document.createElement('div');
                        row.className = 'saved-stop-item';
                        if (i === 0) row.style.backgroundColor = '#e8f5e9';
                        const destLabel = d.dest || d.bound || resolveBusDestination(d.stop) || '';
                        const destHtml = destLabel ? `<div class="saved-dest">${destLabel}</div>` : '';
                        const etaHtml = `<div class="saved-eta-item">${d.co && (d.stop.co==='JOINT' || (d.stop.kmbId && d.stop.ctbId)) ? `<span class="saved-eta-co ${d.co==='KMB'?'kmb':'ctb'}">${d.co}</span>` : ''}<div><span class="saved-eta-time">${d.min}min</span><br><span class="saved-eta-abs">(${d.timeStr})</span></div></div>`;
                        
                        let routeStyle = '';
                        if (d.stop.type === 'mtr' && d.stop.line && MTR_LINES[d.stop.line]) {
                            routeStyle = `style="background:${MTR_LINES[d.stop.line].color};color:white;border-radius:10px;font-size:14px;padding:4px 8px;width:auto;min-width:60px;margin-right:8px;display:flex;justify-content:center;align-items:center;"`;
                        } else if (d.stop.type === 'bus') {
                            let bg = '#747775', txt = 'white';
                            if (d.stop.co === 'KMB') bg = isLWB(d.route) ? '#ff6600' : '#e60012';
                            else if (d.stop.co === 'CTB') { bg = '#f8c300'; txt = 'black'; }
                            else if (d.stop.co === 'JOINT') bg = isLwbCtbJoint(d.route) ? 'linear-gradient(135deg, #ff6600 45%, #f8c300 55%)' : 'linear-gradient(135deg, #e60012 45%, #f8c300 55%)';
                            routeStyle = `style="background:${bg};color:${txt};border-radius:10px;font-size:14px;padding:4px 8px;width:auto;min-width:60px;margin-right:8px;display:flex;justify-content:center;align-items:center;"`;
                        }
                        row.innerHTML = `
                            <div class="saved-route-no" ${routeStyle}>${d.route}</div>
                            <div class="saved-info">
                                ${destHtml}
                                <div class="saved-stop-selected">${d.stop.stopName || d.stop.name || d.stop.stopId || ''}</div>
                            </div>
                            <div class="saved-eta">${etaHtml}</div>
                            <button class="delete-btn" onclick="removeStop('${group.id}', ${d.origIdx})">‚úï</button>
                        `;
                        stopsDiv.appendChild(row);
                    });
                } else {
                    // Normal mode: list stops sorted by route identifier.
                    
                    const stopsWithOrigIdx = group.stops.map((stop, origIdx) => ({ stop, origIdx }));

                    stopsWithOrigIdx.sort((a, b) => {
                        const stopA = a.stop;
                        const stopB = b.stop;
                        const aIsBus = stopA.type === 'bus';
                        const bIsBus = stopB.type === 'bus';

                        if (aIsBus && !bIsBus) return -1; // Buses first
                        if (!aIsBus && bIsBus) return 1;  // MTR after

                        if (aIsBus && bIsBus) {
                            // Both are buses, sort by route number numerically
                            return (stopA.route || '').localeCompare(stopB.route || '', undefined, { numeric: true });
                        } else { // Both are MTR
                            // Sort by line code
                            return (stopA.line || '').localeCompare(stopB.line || '');
                        }
                    });

                    stopsWithOrigIdx.forEach(entry => {
                        const stop = entry.stop;
                        const idx = entry.origIdx;
                        const stopRow = document.createElement('div');
                        stopRow.className = 'saved-stop-item';
                        const resolvedDest = resolveBusDestination(stop) || '';
                        const destDisplay = stop.type === 'mtr' ? '' : (resolvedDest ? (resolvedDest) : '');
                        const destHtml = `<div class="saved-dest">${destDisplay}</div>`;
                        
                        let routeStyle = '';
                        if (stop.type === 'mtr' && stop.line && MTR_LINES[stop.line]) {
                            routeStyle = `style="background:${MTR_LINES[stop.line].color};color:white;border-radius:10px;font-size:14px;padding:4px 8px;width:auto;min-width:60px;margin-right:8px;display:flex;justify-content:center;align-items:center;"`;
                        } else if (stop.type === 'bus') {
                            let bg = '#747775', txt = 'white';
                            if (stop.co === 'KMB') bg = isLWB(stop.route) ? '#ff6600' : '#e60012';
                            else if (stop.co === 'CTB') { bg = '#f8c300'; txt = 'black'; }
                            else if (stop.co === 'JOINT') bg = isLwbCtbJoint(stop.route) ? 'linear-gradient(135deg, #ff6600 45%, #f8c300 55%)' : 'linear-gradient(135deg, #e60012 45%, #f8c300 55%)';
                            routeStyle = `style="background:${bg};color:${txt};border-radius:10px;font-size:14px;padding:4px 8px;width:auto;min-width:60px;margin-right:8px;display:flex;justify-content:center;align-items:center;"`;
                        }
                        stopRow.innerHTML = `
                            <div class="saved-route-no" ${routeStyle}>${stop.route}</div>
                            <div class="saved-info">
                                ${destHtml}
                                <div class="saved-stop-selected">${stop.stopName || stop.name || stop.stopId || ''}</div>
                            </div>
                            <div class="saved-eta" id="dash-eta-${group.id}-${idx}"></div>
                            <button class="delete-btn" onclick="removeStop('${group.id}', ${idx})">‚úï</button>
                        `;
                        stopsDiv.appendChild(stopRow);
                        allNormalModePromises.push(fetchDashboardEta(stop, `dash-eta-${group.id}-${idx}`));
                    });
                }
            }
            container.appendChild(groupDiv);
        }
        
        // Add new group button
        const addGroupBtn = document.createElement('div');
        addGroupBtn.style.cssText = 'background:#006c4c;border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;cursor:pointer;color:white;font-weight:500;';
        addGroupBtn.textContent = '+ Êñ∞Â¢ûÁæ§ÁµÑ';
        addGroupBtn.onclick = () => {
            const groupName = prompt('Ëº∏ÂÖ•Áæ§ÁµÑÂêçÁ®±:', '');
            if(groupName && groupName.trim()) {
                const newId = 'g' + Date.now();
                userGroups.push({ id: newId, name: groupName, stops: [], sortAsc: true });
                saveGroups();
            }
        };
        container.appendChild(addGroupBtn);

        await Promise.all(allNormalModePromises);
    }

    // Helper: return earliest ETA Date object for a stop or null
    async function fetchNextEtaForStop(stop) {
        try {
            if (stop.type === 'mtr') {
                const res = await fetch(`${API_MTR}?line=${stop.line}&sta=${stop.stopId}`);
                const json = await res.json();
                const key = `${stop.line}-${stop.stopId}`;
                if (!json.data || !json.data[key]) return null;
                
                let trains = [];
                if (stop.dir && (stop.dir === 'UP' || stop.dir === 'DOWN')) {
                    trains = json.data[key][stop.dir] || [];
                } else {
                    trains = [...(json.data[key].UP||[]), ...(json.data[key].DOWN||[])];
                }

                if (trains.length === 0) return null;
                const times = trains.map(t => new Date(t.time.replace(/-/g, '/')));
                return new Date(Math.min(...times.map(d=>d.getTime())));
            } else {
                const targetDir = stop.dir === 'outbound' ? 'O' : 'I';
                let promises = [];
                if (stop.kmbId && stop.kmbId !== 'null') promises.push(fetch(`${API_KMB}/eta/${stop.kmbId}/${stop.route}/1`).then(r=>r.json()).then(d=>d.data.map(e=>({...e, co:'KMB'}))));
                if (stop.ctbId && stop.ctbId !== 'null') promises.push(fetch(`${API_CTB}/eta/CTB/${stop.ctbId}/${stop.route}`).then(r=>r.json()).then(d=>d.data.map(e=>({...e, co:'CTB'}))));
                const results = await Promise.all(promises);
                const allEtas = results.flat().filter(e => e.dir === targetDir && e.eta && routeMatches(e, stop.route)).map(e => new Date(e.eta));
                if (allEtas.length === 0) return null;
                return new Date(Math.min(...allEtas.map(d=>d.getTime())));
            }
        } catch (e) { return null; }
    }

    // Fetch all upcoming departures for a specific stop (returns array of {time, timeStr, min, route, bound, co})
    async function fetchDeparturesForStop(stop) {
        try {
            if (stop.type === 'mtr') {
                const res = await fetch(`${API_MTR}?line=${stop.line}&sta=${stop.stopId}`);
                const json = await res.json();
                const key = `${stop.line}-${stop.stopId}`;
                if (!json.data || !json.data[key]) return [];
                
                let trains = [];
                if (stop.dir && (stop.dir === 'UP' || stop.dir === 'DOWN')) {
                    trains = json.data[key][stop.dir] || [];
                } else {
                    trains = [...(json.data[key].UP||[]), ...(json.data[key].DOWN||[])];
                }

                return trains.map(t => {
                    const dt = new Date(t.time.replace(/-/g, '/'));
                    const min = Math.max(0, Math.floor((dt - new Date())/60000));
                    const timeStr = t.time.split(' ')[1].substr(0, 5);
                    const destName = MTR_STATION_NAMES[t.dest] || t.dest;
                    const bound = `${destName}`;
                    return { time: dt, timeStr, min, route: stop.route, bound, dest: destName, co: 'MTR' };
                }).filter(x => x.time);
            } else {
                const targetDir = stop.dir === 'outbound' ? 'O' : 'I';
                let promises = [];
                if (stop.kmbId && stop.kmbId !== 'null') promises.push(fetch(`${API_KMB}/eta/${stop.kmbId}/${stop.route}/1`).then(r=>r.json()).then(d=>d.data.map(e=>({...e, co:'KMB'}))));
                if (stop.ctbId && stop.ctbId !== 'null') promises.push(fetch(`${API_CTB}/eta/CTB/${stop.ctbId}/${stop.route}`).then(r=>r.json()).then(d=>d.data.map(e=>({...e, co:'CTB'}))));
                const results = await Promise.all(promises);
                const allEtas = results.flat().filter(e => e.dir === targetDir && e.eta && routeMatches(e, stop.route)).map(e => {
                    const dt = new Date(e.eta);
                    const min = Math.max(0, Math.floor((dt - new Date())/60000));
                    const destName = e.dest_tc || e.destination_tc || e.dest || stop.dest || '';
                    return { time: dt, timeStr: dt.toLocaleTimeString('en-GB',{hour12:false}), min, route: stop.route, bound: destName || (stop.dir || (e.dir === 'O' ? 'Out' : 'In')), dest: destName, co: e.co };
                });
                return allEtas;
            }
        } catch (e) { return []; }
    }

    // Refresh logic across all groups: re-render ascending groups, update ETA blocks for normal groups
    async function refreshAllGroups() {
        const anyAsc = userGroups.some(g => g.sortAsc && g.stops.length>0);
        if (anyAsc) await renderDashboard();
        userGroups.forEach(g => { if (!g.sortAsc) refreshGroup(g.id); });
    }

    async function removeStop(groupId, idx) {
        const group = userGroups.find(g => g.id === groupId);
        if(group) {
            group.stops.splice(idx, 1);
            await saveGroups();
        }
    }

    async function deleteGroup(groupId) {
        if(userGroups.length <= 1) { showToast('Ëá≥Â∞ëË¶Å‰øùÁïô‰∏ÄÂÄãÁæ§ÁµÑ'); return; }
        if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Áæ§ÁµÑÔºü')) {
            userGroups = userGroups.filter(g => g.id !== groupId);
            await saveGroups();
        }
    }

    function editGroupName(groupId) {
        const group = userGroups.find(g => g.id === groupId);
        if(!group) return;
        currentEditingGroupId = groupId;
        const modal = document.getElementById('rename-group-modal');
        const input = document.getElementById('rename-group-input');

        input.value = group.name;
        modal.style.display = 'block';
        input.focus();
        input.select();
        
        input.onkeydown = (e) => {
            if (e.key === 'Enter') saveGroupName();
            else if (e.key === 'Escape') modal.style.display = 'none';
        };
    }

    async function saveGroupName() {
        if (!currentEditingGroupId) return;
        const group = userGroups.find(g => g.id === currentEditingGroupId);
        const modal = document.getElementById('rename-group-modal');
        const input = document.getElementById('rename-group-input');
        const newName = input.value.trim();
        if(group && newName) {
            group.name = newName;
            await saveGroups();
        }
        modal.style.display = 'none';
        currentEditingGroupId = null;
        input.onkeydown = null;
    }

    function refreshGroup(groupId) {
        const group = userGroups.find(g => g.id === groupId);
        if(!group) return;
        if (group.sortAsc) { renderDashboard(); return; }
        group.stops.forEach((stop, idx) => {
            const el = document.getElementById(`dash-eta-${group.id}-${idx}`);
            if (el) {
                el.innerText = '...';
                fetchDashboardEta(stop, `dash-eta-${group.id}-${idx}`);
            }
        });
    }

    async function fetchDashboardEta(stop, elemId) {
        const el = document.getElementById(elemId);
        if(!el) return;
        
        try {
            if(stop.type === 'mtr') {
                const res = await fetch(`${API_MTR}?line=${stop.line}&sta=${stop.stopId}`);
                const json = await res.json();
                const key = `${stop.line}-${stop.stopId}`;
                if(json.status === 0 || !json.data[key]) { el.innerHTML = '<div style="color:#999;font-size:12px;">-</div>'; return; }
                
                let trains = [];
                if (stop.dir && (stop.dir === 'UP' || stop.dir === 'DOWN')) {
                    trains = json.data[key][stop.dir] || [];
                } else {
                    trains = [...(json.data[key].UP || []), ...(json.data[key].DOWN || [])];
                }

                if(trains.length > 0) {
                    const uniqueDests = [...new Set(trains.map(t => MTR_STATION_NAMES[t.dest] || t.dest))].filter(Boolean);
                    if (uniqueDests.length > 0) {
                        const destStr = uniqueDests.join('/');
                        const stopItemElem = el.closest('.saved-stop-item');
                        if (stopItemElem) {
                            const destElem = stopItemElem.querySelector('.saved-dest');
                            if (destElem) destElem.innerText = destStr;
                        }
                    }

                     let html = '';
                     trains.slice(0, 4).forEach((t, i) => {
                         const min = Math.max(0, Math.floor((new Date(t.time.replace(/-/g, "/")) - new Date())/60000));
                         const timeStr = t.time.split(' ')[1].substr(0, 5);
                         const destName = MTR_STATION_NAMES[t.dest] || t.dest;
                         const hl = i === 0 ? 'background-color:#e8f5e9;padding:2px 4px;border-radius:4px;' : '';
                         html += `<div class="saved-eta-item" style="${hl}"><div><span class="saved-eta-time">${destName} ${min}min</span><br><span class="saved-eta-abs">(${timeStr})</span></div></div>`;
                     });
                     el.innerHTML = html;
                } else { el.innerHTML = '<div style="color:#999;font-size:12px;">-</div>'; }

            } else {
                const targetDir = stop.dir === 'outbound' ? 'O' : 'I';
                let promises = [];
                if(stop.kmbId && stop.kmbId !== 'null') promises.push(fetch(`${API_KMB}/eta/${stop.kmbId}/${stop.route}/1`).then(r=>r.json()).then(d=>d.data.map(e=>({...e, co:'KMB'}))));
                if(stop.ctbId && stop.ctbId !== 'null') promises.push(fetch(`${API_CTB}/eta/CTB/${stop.ctbId}/${stop.route}`).then(r=>r.json()).then(d=>d.data.map(e=>({...e, co:'CTB'}))));
                
                const results = await Promise.all(promises);
                    const allEtas = results.flat().filter(e => e.dir === targetDir && e.eta && routeMatches(e, stop.route));

                    if(allEtas.length > 0) {
                        // merge and sort across operators, then take up to 6 departures
                        allEtas.sort((a,b) => new Date(a.eta) - new Date(b.eta));
                        const merged = allEtas.slice(0, 6);
                        const isJoint = stop.co === 'JOINT' || (stop.kmbId && stop.ctbId && stop.kmbId !== 'null' && stop.ctbId !== 'null');
                        let html = '';
                        merged.forEach((e, i) => {
                            const min = Math.max(0, Math.floor((new Date(e.eta) - new Date())/60000));
                            const timeStr = new Date(e.eta).toLocaleTimeString('en-GB',{hour12:false});
                            const coClass = e.co === 'KMB' ? (isLWB(stop.route) ? 'lwb' : 'kmb') : 'ctb';
                            const hl = i === 0 ? 'background-color:#e8f5e9;padding:2px 4px;border-radius:4px;' : '';
                            const coHtml = isJoint ? `<span class="saved-eta-co ${coClass}">${e.co}</span>` : '';
                            html += `<div class="saved-eta-item" style="${hl}">${coHtml}<div><span class="saved-eta-time">${min}min</span><br><span class="saved-eta-abs">(${timeStr})</span></div></div>`;
                        });
                        el.innerHTML = html;
                    } else { el.innerHTML = '<div style="color:#999;font-size:12px;">-</div>'; }
            }
        } catch(e) { el.innerHTML = '<div style="color:#999;font-size:12px;">Err</div>'; }
    }

    // --- Modal & Stop Logic (with Long Press) ---
    async function openBusModal(route) {
        setupModal(route.route, route.dest);
        const listDiv = document.getElementById('modal-body');
        listDiv.innerHTML = '<div class="loading">ËºâÂÖ•‰∏≠...</div>';

        try {
            let finalStops = [];
            const dirCode = route.boundKey; 

            if (route.isJoint) {
                const [kmbRes, ctbRes] = await Promise.all([
                    fetch(`${API_KMB}/route-stop/${route.route}/${dirCode}/1`).then(r=>r.json()),
                    fetch(`${API_CTB}/route-stop/CTB/${route.route}/${dirCode}`).then(r=>r.json())
                ]);
                const kmbStops = await Promise.all(kmbRes.data.map(s => fetch(`${API_KMB}/stop/${s.stop}`).then(r=>r.json()).then(d=>({seq:s.seq, id:s.stop, name:d.data.name_tc}))));
                finalStops = kmbStops.map(k => {
                    const c = ctbRes.data ? ctbRes.data.find(x => parseInt(x.seq)===parseInt(k.seq)) : null;
                    return { name: k.name, kmbId: k.id, ctbId: c?c.stop:null, route: route.route, dir: route.boundKey, dest: route.dest, type: 'bus', co: route.co };
                });
            } else if (route.co === 'KMB') {
                const res = await fetch(`${API_KMB}/route-stop/${route.route}/${dirCode}/1`).then(r=>r.json());
                finalStops = await Promise.all(res.data.map(s => fetch(`${API_KMB}/stop/${s.stop}`).then(r=>r.json()).then(d=>({name:d.data.name_tc, kmbId:s.stop, ctbId:null, route:route.route, dir:route.boundKey, dest:route.dest, type:'bus', co:'KMB'}))));
            } else {
                const res = await fetch(`${API_CTB}/route-stop/CTB/${route.route}/${dirCode}`).then(r=>r.json());
                if(res.data) finalStops = await Promise.all(res.data.map(s => fetch(`${API_CTB}/stop/${s.stop}`).then(r=>r.json()).then(d=>({name:d.data.name_tc, kmbId:null, ctbId:s.stop, route:route.route, dir:route.boundKey, dest:route.dest, type:'bus', co:'CTB'}))));
            }
            renderStops(finalStops, 'bus');
        } catch(e) { listDiv.innerHTML = '<div class="loading">ËºâÂÖ•Â§±Êïó</div>'; }
    }

    async function openMtrModal(route) {
        setupModal(route.route, 'ÈõôÂêëÁè≠Ê¨°');
        const lineData = MTR_LINES[route.code];
        const stops = lineData.stops.map(s => ({
            name: MTR_STATION_NAMES[s] || s,
            stopId: s,
            line: route.code,
            route: route.route,
            color: route.color,
            type: 'mtr'
        }));
        renderStops(stops, 'mtr');
    }

    function renderStops(stops, type) {
        const listDiv = document.getElementById('modal-body');
        let html = '';
        stops.forEach((s, i) => {
            const dataStr = encodeURIComponent(JSON.stringify(s)).replace(/'/g, "%27");
            const dotStyle = type==='mtr' ? `style="border-color:${s.color}"` : '';
            const addBtn = type === 'mtr' ? '' : `<button class="add-stop-btn" onclick="event.stopPropagation(); promptAddToGroup(JSON.parse(decodeURIComponent('${dataStr}')))">Ôºã</button>`;
            html += `
                <div class="stop-item" data-stop='${dataStr}' onclick="onStopClick(this, '${dataStr}')">
                    <div class="stop-row">
                        <div class="stop-timeline"><div class="stop-dot" ${dotStyle}></div></div>
                        <div class="stop-name" style="flex:1">${s.name}</div>
                        ${addBtn}
                    </div>
                    <div class="eta-container"></div>
                </div>`;
        });
        listDiv.innerHTML = html;
    }

    function onStopClick(elem, dataStr) {
        const data = JSON.parse(decodeURIComponent(dataStr));
        if(data.type === 'mtr') toggleMtrEta(data.line, data.stopId, elem);
        else toggleBusEta(data.kmbId, data.ctbId, data.route, data.dir, elem);
    }

    // --- Long Press & ETA ---
    let pressTimer;
    let isLongPress = false;

    function handlePressStart(elem, dataStr) {
        isLongPress = false;
        elem.classList.add('holding');
        pressTimer = setTimeout(() => {
            isLongPress = true;
            elem.classList.remove('holding');
            promptAddToGroup(JSON.parse(decodeURIComponent(dataStr)));
        }, 600); 
    }

    function handlePressEnd(elem, dataStr) {
        clearTimeout(pressTimer);
        elem.classList.remove('holding');
        if (!isLongPress) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            if(data.type === 'mtr') toggleMtrEta(data.line, data.stopId, elem);
            else toggleBusEta(data.kmbId, data.ctbId, data.route, data.dir, elem);
        }
    }

    function cancelPress(elem) {
        clearTimeout(pressTimer);
        elem.classList.remove('holding');
    }

    let pendingStopData = null;
    let currentEditingGroupId = null;

    function promptAddToGroup(stopData) {
        pendingStopData = stopData;
        const modal = document.getElementById('group-select-modal');
        const body = modal.querySelector('.group-select-body');
        body.innerHTML = '';
        
        userGroups.forEach(group => {
            const option = document.createElement('div');
            option.className = 'group-option';
            option.innerHTML = `<span>${group.name}</span><span>(${group.stops.length})</span>`;
            option.onclick = () => {
                addStopToGroup(stopData, group.id);
                modal.style.display = 'none';
            };
            body.appendChild(option);
        });
        
        modal.style.display = 'block';
    }

    async function addStopToGroup(stopData, groupId) {
        const targetGroup = userGroups.find(g => g.id === groupId);
        if(!targetGroup) return;
        
        const exists = targetGroup.stops.some(s => 
            s.route === stopData.route && 
            (s.name === stopData.name || s.stopName === stopData.name) &&
            s.dir === stopData.dir
        );
        if(exists) { showToast('Ë©≤Á´ôÈªûÂ∑≤Âú®Áæ§ÁµÑ‰∏≠'); return; }

        if (stopData.type === 'mtr') {
            // ÂØπ‰∫éMTRÔºå‰ΩøÁî®ÊòæÁ§∫ÁöÑÊñπÂêëÂêçÁß∞ËÄå‰∏çÊòØ‰ª£Á†Å
            stopData.dest = stopData.name;
        }

        targetGroup.stops.push(stopData);
        await saveGroups();
        showToast(`Â∑≤Âä†ÂÖ• ${targetGroup.name}`);
    }

    async function toggleBusEta(kmbId, ctbId, routeNo, boundKey, elem, isRefresh = false) {
        const container = elem.querySelector('.eta-container');
        if (!isRefresh && container.style.display === 'block') { container.style.display = 'none'; return; }
        
        container.style.display = 'block';
        container.innerHTML = '<span style="color:#999;font-size:13px;">ËºâÂÖ•‰∏≠...</span>';
        const targetDir = boundKey === 'outbound' ? 'O' : 'I';

        try {
            let promises = [];
            if (kmbId && kmbId !== 'null') promises.push(fetch(`${API_KMB}/eta/${kmbId}/${routeNo}/1`).then(r => r.json()).then(d => d.data.map(e => ({...e, co: 'KMB'}))));
            if (ctbId && ctbId !== 'null') promises.push(fetch(`${API_CTB}/eta/CTB/${ctbId}/${routeNo}`).then(r => r.json()).then(d => d.data.map(e => ({...e, co: 'CTB'}))));

            const results = await Promise.all(promises);
            let allEtas = results.flat().filter(e => e.eta && routeMatches(e, routeNo)).sort((a, b) => new Date(a.eta) - new Date(b.eta));

            const refreshBtn = `<div style="text-align:right;margin-bottom:6px;"><button style="font-size:12px;padding:4px 10px;border:1px solid #ddd;background:#fff;border-radius:12px;color:#333;cursor:pointer;" onclick="event.stopPropagation(); toggleBusEta('${kmbId}', '${ctbId}', '${routeNo}', '${boundKey}', this.closest('.stop-item'), true)" onmousedown="event.stopPropagation()" onmouseup="event.stopPropagation()" ontouchstart="event.stopPropagation()" ontouchend="event.stopPropagation()">‚Üª Âà∑Êñ∞</button></div>`;

            if (allEtas.length === 0) { container.innerHTML = refreshBtn + '<span style="color:#999;font-size:13px;">Êö´ÁÑ°Áè≠Ê¨°</span>'; return; }

            // Filter by target direction only
            const validEtas = allEtas.filter(e => e.dir === targetDir);
            if (validEtas.length === 0) { container.innerHTML = refreshBtn + '<span style="color:#999;font-size:13px;">Êö´ÁÑ°Áè≠Ê¨°</span>'; return; }

            const baseStop = getStopFromElem(elem) || {};
            let html = '';
            
            // Group by destination
            const groups = {};
            const destOrder = [];
            validEtas.forEach(e => {
                const d = e.dest_tc || e.destination_tc || e.destination || e.dest || '';
                if(!groups[d]) { groups[d] = []; destOrder.push(d); }
                groups[d].push(e);
            });

            destOrder.forEach(dest => {
                const list = groups[dest];
                const first = list[0];
                const stopData = { type: 'bus', name: baseStop.name || '', kmbId: baseStop.kmbId || null, ctbId: baseStop.ctbId || null, route: routeNo, dir: boundKey, dest: dest, co: first.co };
                const ds = encodeURIComponent(JSON.stringify(stopData));
                
                html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid #eee;margin-top:4px;">
                            <span style="font-size:12px;font-weight:700;color:#006c4c;">${dest}</span>
                         </div>`;
                
                const isJoint = (kmbId && kmbId !== 'null') && (ctbId && ctbId !== 'null');
                list.slice(0, 6).forEach((e, i) => {
                    const min = Math.max(0, Math.floor((new Date(e.eta) - new Date()) / 60000));
                    const timeStr = new Date(e.eta).toLocaleTimeString('en-GB',{hour12:false});
                    const hl = i === 0 ? 'background-color:#e8f5e9;border-radius:6px;padding:0 4px;' : '';
                    const coHtml = isJoint ? `<span class="co-pill ${e.co==='KMB'?(isLWB(routeNo)?'pill-lwb':'pill-kmb'):'pill-ctb'}">${e.co}</span>` : '';
                    html += `<div class="eta-badge" style="${hl}"><div class="eta-left">${coHtml}<span class="eta-main">${min}min</span><span class="eta-abs">(${timeStr})</span></div></div>`;
                });
            });

            container.innerHTML = refreshBtn + html;
        } catch (err) { container.innerHTML = 'ÈÄ£Á∑öÈåØË™§'; }
    }

    async function toggleMtrEta(line, station, elem, isRefresh = false) {
        const container = elem.querySelector('.eta-container');
        if (!isRefresh && container.style.display === 'block') { container.style.display = 'none'; return; }
        container.style.display = 'block'; container.innerHTML = '...';

        const res = await fetch(`${API_MTR}?line=${line}&sta=${station}`);
        const json = await res.json();
        const key = `${line}-${station}`;
        const refreshBtn = `<div style="text-align:right;margin-bottom:6px;"><button style="font-size:12px;padding:4px 10px;border:1px solid #ddd;background:#fff;border-radius:12px;color:#333;cursor:pointer;" onclick="event.stopPropagation(); toggleMtrEta('${line}', '${station}', this.closest('.stop-item'), true)" onmousedown="event.stopPropagation()" onmouseup="event.stopPropagation()" ontouchstart="event.stopPropagation()" ontouchend="event.stopPropagation()">‚Üª Âà∑Êñ∞</button></div>`;

        if(!json.data[key]) { container.innerHTML = refreshBtn + 'Êö´ÁÑ°Êï∏Êìö'; return; }
        
        const up = json.data[key].UP || [];
        const down = json.data[key].DOWN || [];
        const baseStop = getStopFromElem(elem) || {};
        
        const renderDir = (trains, dirStr) => {
            if(!trains || trains.length === 0) return '';
            
            // Heuristic: If fewer than 4 trains are returned, the last one is likely the last train of the day.
            const lastTrainIndex = trains.length < 4 ? trains.length - 1 : -1;
            
            const groups = {};
            const destOrder = [];
            trains.forEach((t, idx) => {
                if(!groups[t.dest]) { groups[t.dest] = []; destOrder.push(t.dest); }
                t.isLast = (idx === lastTrainIndex);
                groups[t.dest].push(t);
            });
            
            let html = '';
            destOrder.forEach(dest => {
                const list = groups[dest];
                const destName = MTR_STATION_NAMES[dest] || dest || '';
                const stopData = { type: 'mtr', name: baseStop.name || '', line: line, stopId: station, route: baseStop.route || line, dir: dirStr };
                const ds = encodeURIComponent(JSON.stringify(stopData));
                
                html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid #eee;margin-top:4px;">
                            <span style="font-size:12px;font-weight:700;color:#006c4c;">${destName}</span>
                            <button class="eta-add-btn" data-stop='${ds}' onclick="promptAddToGroup(JSON.parse(decodeURIComponent(this.dataset.stop)))">Ôºã</button>
                         </div>`;
                
                list.slice(0, 4).forEach((t, i) => {
                    const min = Math.max(0, Math.floor((new Date(t.time.replace(/-/g,"/")) - new Date())/60000));
                    const timeStr = t.time.split(' ')[1].substr(0,5);
                    const lastBadge = t.isLast ? '<span style="font-size:10px;background:#e60012;color:white;padding:1px 4px;border-radius:4px;margin-left:6px;">Â∞æÁè≠Ëªä</span>' : '';
                    const hl = i === 0 ? 'background-color:#e8f5e9;border-radius:6px;padding:0 4px;' : '';
                    html += `<div class="eta-badge" style="${hl}"><div class="eta-left"><span class="eta-main">${min}min</span><span class="eta-abs">(${timeStr})</span>${lastBadge}</div></div>`;
                });
            });
            return html;
        };

        const leftHtml = renderDir(up, 'UP');
        const rightHtml = renderDir(down, 'DOWN');
        container.innerHTML = refreshBtn + (`<div style="display:flex;gap:12px;"><div style="flex:1">${leftHtml}</div><div style="flex:1">${rightHtml}</div></div>` || 'Êö´ÁÑ°Áè≠Ê¨°');
    }

    function setupModal(title, sub) {
        const m = document.getElementById('route-modal');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-subtitle').innerText = sub;
        m.style.display = 'flex';
    }
    function closeModal() { document.getElementById('route-modal').style.display = 'none'; }

    // Start auto-refresh every 30 seconds (ensure single interval)
    if (!window.__hk_auto_refresh_started) {
        window.__hk_auto_refresh_started = true;
        // initial refresh after short delay to allow initial render
        setTimeout(refreshAllGroups, 2000);
        setInterval(refreshAllGroups, 30000);
    }

    // --- Pull to Refresh ---
    function initPullToRefresh() {
        const view = document.getElementById('view-dashboard');
        const indicator = document.createElement('div');
        indicator.id = 'ptr-indicator';
        indicator.innerHTML = `<span class="ptr-text">‰∏ãÊãâÂà∑Êñ∞</span>`;
        view.prepend(indicator);

        let startY = 0;
        let pullDistance = 0;
        let isRefreshing = false;
        const threshold = 80;
        const resistance = 2.5;

        document.body.addEventListener('touchstart', e => {
            if (isRefreshing || !view.classList.contains('active') || document.documentElement.scrollTop > 0) {
                return;
            }
            startY = e.touches[0].clientY;
            view.style.transition = 'none';
        }, { passive: true });

        document.body.addEventListener('touchmove', e => {
            if (startY === 0 || isRefreshing) return;

            const currentY = e.touches[0].clientY;
            pullDistance = currentY - startY;

            if (pullDistance > 0 && document.documentElement.scrollTop === 0) {
                e.preventDefault();
                const resistedPull = pullDistance / resistance;
                view.style.transform = `translateY(${resistedPull}px)`;
                indicator.querySelector('.ptr-text').innerText = resistedPull > threshold ? 'ÊùæÂºÄÂç≥ÂèØÂà∑Êñ∞' : '‰∏ãÊãâÂà∑Êñ∞';
            }
        }, { passive: false });

        document.body.addEventListener('touchend', e => {
            if (startY === 0 || isRefreshing) return;

            const resistedPull = pullDistance / resistance;
            view.style.transition = 'transform 0.3s';

            if (resistedPull > threshold) {
                isRefreshing = true;
                view.style.transform = `translateY(${threshold / resistance}px)`;
                indicator.querySelector('.ptr-text').innerText = 'Âà∑Êñ∞‰∏≠...';
                renderDashboard().finally(() => {
                    view.style.transform = 'translateY(0)';
                    setTimeout(() => { isRefreshing = false; startY = 0; pullDistance = 0; }, 300);
                });
            } else {
                view.style.transform = 'translateY(0)';
                startY = 0;
                pullDistance = 0;
            }
        });
    }
    initPullToRefresh();
</script>

</body>
</html>